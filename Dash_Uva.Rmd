---
title: "DASHBOARD MERCADO DE UVA"
#author: "João Ricardo Lima"
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - {title: "OBSERVATÓRIO DO MERCADO DE UVA", href: "https://www.embrapa.br/observatorio-da-uva", align: right}
    orientation: rows
    #css: styles.css
    vertical_layout: fill #sem barra de rolagem e scroll com barra
    theme: 
      version: 4
      bootswatch: bootstrap
      navbar-bg: "#183b8c"
      bg:        "#183b8c"
      fg:        "#ffffff"
#runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(foreign)
library(mFilter)
library(forecast)
library(dplyr)
library(tsutils)
library(xts)
library(ggthemes)
library(FinTS)
library(scales)
library(ggplot2)
library(reshape)
library(reshape2)
library(imputeTS)
library(seasonal)
library(uroot)
library(tseries)
library(quantmod)
library(kableExtra)# complex tables
library(lmtest)
library(dygraphs)
library(plotly)
library(DT)
library(lubridate)
library(rmarkdown)
library(bslib)
library(shiny)
library(magrittr)# pipe operations
library(readxl)

checkX13()

knitr::opts_chunk$set(
  echo       = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.align  = "left",
  comment    = "#"
  )

library(lubridate)
anterior <- as.Date("2022-02-01")
atual <-  as.Date("2022-03-01")
data <- as.Date("2022-04-08")
sem_ano <- 14 #ajustar semanalmente
mes <- 3
# Linhas que precisam de ajuste: 71, 104, 107
```

BRASIL {data-navmenu="DADOS GERAIS"}
======================================================================

```{r database5}
#Direcionado o R para o Diretorio a ser trabalhado
setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_uva')

options(digits=4)
today <- as.Date("2022-01-01")
date <- seq(as.Date('2021-01-01'),to=as.Date('2021-12-01'),by='1 month')
date2 <- seq(as.Date('2021-01-01'),to=as.Date('2021-12-01'),by='1 month')

#Entrando dados no R
dados <- read_excel("uva_ibge2020.xlsx", col_names = TRUE)
dados$produtividade <- round(dados$produtividade,0)

#Cores para os gráficos

mycolor1 <- "gold"
mycolor2 <- "darkgreen"
mycolor3 <- "blue"
mycolor4 <- "red"
```

Row {data-height=150}
-----------------------------------------------------------------------

### Área Plantada com Uva no Brasil em 2020 
``` {r}
num <- 28.261 
valueBox(
  value = paste0(num, " Hectares"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Produtividade média da Uva no Brasil em 2020 
``` {r}
num <- 25
valueBox(
  value = paste0( num, " Toneladas/Hectare"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Volume com Uva produzida no Brasil em 2020 
``` {r}
num <- 700.3
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Mil Toneladas" ),
#  color = "lightblue3",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Evolução da Area com uva no Brasil: 2016:2020 {.no-title}

```{r ibge1}
g1 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=area, fill="Area uva (Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor1)+
  labs(y= "Hectares", x= "Anos", title='Evolução da Area com Uva no Brasil: 2016-2020',
       caption = "Fonte: IBGE (2021)") +
  scale_y_continuous(limits=c(0, 30000), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

### Evolução do Volume com uva no Brasil: 2016-2020 {.no-title}

```{r ibge2}
g2 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=quantidade/1000, fill="Volume (Mil Toneladas)"), lwd=1)+
  scale_fill_manual(values=mycolor2)+
  labs(y= "Mil Toneladas", x= "Anos", title='Evolução do Volume de Uva no Brasil: 2016-2020',
       caption = "Fonte: IBGE (2021)") +
  scale_y_continuous(limits=c(0, 900), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Evolução da Produtividade com uva no Brasil: 2016-2020 {.no-title}

```{r ibge3}
g3 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=produtividade, fill="Produtividade (Toneladas/Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor3)+
  labs(y= "Produtividade (Ton/Ha)", x= "Anos", title='Evolução da Produtividade da Uva no Brasil: 2016-2020',
       caption = "IBGE (2021)") +
  scale_y_continuous(limits=c(0, 30), n.breaks = 5, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

### Evolução do Valor Bruto da Produção com uva no Brasil: 2016-2020  {.no-title}

```{r ibge4}
g4 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=vbp/1000, fill="Valor Bruto Produção (Mil R$)"), lwd=1)+
  scale_fill_manual(values=mycolor4)+
  labs(y= "VBP (Mil R$)", x= "Anos", title='Evolução do Valor Bruto da Produção da Uva no Brasil: 2016-2020',
       caption = "IBGE (2021)") +
  scale_y_continuous(limits=c(0, 2600), n.breaks = 5, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```


VALE DO S. FRANCISCO {data-navmenu="DADOS GERAIS"}
======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### Área Plantada com Uva no Vale S. Francisco em 2020 
``` {r}
num <- 10.113 
valueBox(
  value = paste0(num, " Hectares"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Produtividade média da Uva no Vale S. Francisco em 2020 
``` {r}
num <- 38
valueBox(
  value = paste0( num, " Toneladas/Hectare"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Volume com Uva produzida no Vale S. Francisco em 2020 
``` {r}
num <- 388.3
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Mil Toneladas" ),
#  color = "lightblue3",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Evolução da Area com uva no Vale do São Francisco: 2016:2020 {.no-title}

```{r ibge1b}
g1 <- ggplot(data=dados) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=area, fill="Area uva (Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor1)+
  labs(y= "Hectares", x= "Anos", title='Evolução da Area com Uva no Vale do São Francisco: 2016-2020',
       caption = "Fonte: IBGE (2021)") +
  scale_y_continuous(limits=c(0, 12000), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

### Evolução do Volume com uva no Vale do São Francisco: 2016-2020 {.no-title}

```{r ibge2b}
g2 <- ggplot(data=dados) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=quantidade/1000, fill="Volume (Mil Toneladas)"), lwd=1)+
  scale_fill_manual(values=mycolor2)+
  labs(y= "Mil Toneladas", x= "Anos", title='Evolução do Volume de Uva no Vale do São Francisco: 2016-2020',
       caption = "Fonte: IBGE (2021)") +
  scale_y_continuous(limits=c(0, 600), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Evolução da Produtividade com uva no Vale do São Francisco: 2016-2020 {.no-title}

```{r ibge3b}
g3 <- ggplot(data=dados) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=produtividade, fill="Produtividade (Toneladas/Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor3)+
  labs(y= "Produtividade (Ton/Ha)", x= "Anos", title='Evolução da Produtividade da Uva no Vale do São Francisco: 2016-2020',
       caption = "IBGE (2021)") +
  scale_y_continuous(limits=c(0, 60), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

### Evolução do Valor Bruto da Produção com uva no Vale do São Francisco: 2016-2020  {.no-title}

```{r ibge4b}
g4 <- ggplot(data=dados) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=vbp/1000, fill="Valor Bruto Produção (Mil R$)"), lwd=1)+
  scale_fill_manual(values=mycolor4)+
  labs(y= "VBP (Mil R$)", x= "Anos", title='Evolução do Valor Bruto da Produção da Uva no Vale do São Francisco: 2016-2020',
       caption = "IBGE (2021)") +
  scale_y_continuous(limits=c(0, 1600), n.breaks = 5, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.40,
                      title=''))
```

BRANCA SEEDLESS EMBALADA {data-navmenu="PREÇOS AO PRODUTOR"}
======================================================================

``` {r database1}
#Direcionado o R para o Diretorio a ser trabalhado
setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_Uva')

options(digits=4)

#Entrando dados no R Branca Arra-15
dados1 <- read.csv2('dados_uva_arra_semana.csv', header=T, sep=";", dec=".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados1)[1]<-'produto'


#Entrando dados no R Vitoria com Embalagem
dados2 <- read.csv2('dados_uva_vitoria_semana.csv', header=T, sep=";", dec=".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados2)[1]<-'produto'


#Entrando dados no R Vitoria sem Embalagem
dados3 <- read.csv2('dados_uva_vitoriaSE_semana.csv', header=T, sep=";", dec=".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados3)[1]<-'produto'


#organização das bases para Uva Branca e Vitoria Embalada

#Entrando dados no R - Deflator
igpdi <- read.csv2('igpdi_uva.csv', 
                   header=T, sep=";",
                   dec=".")
colnames(igpdi)[1]<-'ano'

#Juntar tudo em um unico tibble
dados <- full_join(dados1, dados2) %>% full_join(igpdi)

#Resolver os Missing
dados <-na_kalman(dados)

#Deflacionar a série de precos
dados$preco_def <- dados[,4]*(tail(dados[,5],1)/dados[,5])

#Criando uma variável com as datas semanais
dados$date <- seq(as.Date('2017-01-07'),to=data,by='1 week')

#Passar para um Tibble
dados <- tibble(dados)

#Ajustando como uma série temporal
dados <- dados %>% 
  select(c(date, produto, preco_def, ano))

#organização da base para Vitoria Sem Embalagem

igpdi2 <- igpdi %>% filter(ano >= '2019')

#Juntar tudo em um unico tibble
dadosv <- full_join(dados3, igpdi2)

#Resolver os Missing
dadosv <-na_kalman(dadosv)

#Deflacionar a série de precos
dadosv$preco_def <- dadosv[,4]*(tail(dadosv[,5],1)/dadosv[,5])

#Criando uma variável com as datas semanais
dadosv$date <- seq(as.Date('2019-01-07'),to=data,by='1 week')

#Passar para um Tibble
dadosv <- tibble(dadosv)

#Ajustando como uma série temporal
dadosv <- dadosv %>% 
  select(c(date, produto, preco_def, ano))


#Geração das tendencias

arra <- dados%>% filter(produto=="arra_15")
vitoria <- dados %>% filter(produto=="vitoria")
vitoriase <- dadosv

preco_arra <- ts(arra[,3], start=c(2017,1), freq=52)
sazonal_arra <- cmav(preco_arra, outplot = F)

preco_vitoria <- ts(vitoria[,3], start=c(2017,1), freq=52)
sazonal_vitoria <- cmav(preco_vitoria, outplot = F)

preco_vitoriase <- ts(vitoriase[,3], start=c(2019,1), freq=52)
sazonal_vitoriase <- cmav(preco_vitoriase, outplot = F)

# Parte 2
#Decompor a Série
decompa<-decompose(preco_arra, type = 'multiplicative')

sazonalidade <- decompa$figure
semanas <- seq(1:52)
sazonal_graph <- tibble(cbind(semanas, sazonalidade))

#Parte 3
#Analise das comparações entre as médias
preco_arra_2019 <- window(preco_arra, end=c(2019,52))
seas19<-seasplot(preco_arra_2019, trend=F, outplot = F)
medias19 <- colMeans(seas19$season)

preco_arra_2020 <- window(preco_arra, end=c(2020,52))

preco_arra_2021 <- window(preco_arra, end=c(2021,52))
#seas21<-seasplot(preco_palmer_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

preco_arra_22 <- as.matrix(tail(arra$preco_def,sem_ano))
preco_arra_2022 <- matrix(NA, nrow=52, ncol=1)

for(i in 1:sem_ano){
  preco_arra_2022[i,1] = preco_arra_22[i,1]
}
  

#Como só se tem até a semana 52
medias19 <- medias19[1:52]
#medias21 <- medias21[1:52]

matrix = matrix(NA, nrow=52, ncol=2)

for(i in 1:52){
  matrix[i,1] = min(seas19$season[,i])
  matrix[i,2] = max(seas19$season[,i])
}

time <- seq(1:52)
table <- data.frame(time, matrix[,1], round(medias19,2), matrix[,2], round(tail(preco_arra_2020,52),2),
                    round(tail(preco_arra_2021,52),2), preco_arra_2022[,1])
colnames(table) = c('Semanas', 'Mínimo', 'Média', 'Máximo', '2020', '2021', 
                    '2022')
tablea <- table[,-c(5:7)]
tableb <- table[,-c(2,3,4)]

tablea2 <- melt(tablea, id.var='Semanas')
tableb2 <- melt(tableb, id.var='Semanas')
mycolors <- c("dodgerblue2", "gold", "darkmagenta")

#Parte 4

preco_arra_21 <- arra %>% filter(ano=='2021')
preco_arra_2021 <- as.matrix(preco_arra_21$preco_def)
variacao_21 <- (preco_arra_2021/lag(preco_arra_2021, 1) - 1)*100

variacao_22 <- (preco_arra_2022/lag(preco_arra_2022, 1) - 1)*100

semanas <- seq(1:52)
variacao <- data.frame(semanas, variacao_21[,1], variacao_22[,1])
colnames(variacao) = c('Semanas', '2021', '2022')

variacao <- melt(variacao, id.var='Semanas')

mycolors2 <- c("orange", "lightblue3")

# Customizar tema interativamente em tempo real (ver mensagens no console)
#bslib::bs_themer()
```

Row {data-height=150}
-----------------------------------------------------------------------

### Preço de Uva Branca Embalada na Semana `r strftime(data, format = "%V")` de 2022 
``` {r}
num <- tail(preco_arra,1)
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  color = "tomato",
  icon= "fa-arrow-down")
#arrow-trend-down
#darkmagenta
```

### Preço de Uva Branca Embalada na Semana `r strftime(data, format = "%V")` de 2021
``` {r}
num <- 8.39
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  icon= "fa-pen")
```

### Preço de Uva Branca Embalada na Semana `r strftime(data, format = "%V")` de 2020
``` {r}
num <-10.94
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Mínimo, Máximo, Media e preços de 2020 a 2022 de Uva Branca Embalada {.no-title}
```{r palmer3, results='', fig.cap=''}

g1 <- ggplot()+
  geom_col(data=tableb2, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.7,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
    geom_line(data=tablea2, aes(x=Semanas, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
  scale_y_continuous(limits = c(0, 18), n.breaks = 10, labels = number_format(accuracy = 0.01,
                                                       decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Preço R$", x= "Semanas de cada Ano", title='Mínimo, Máximo, Média e preços de 2020 a 2022 de Uva Branca Embalada',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Uva da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.05, 
                      y=1.1,
                      title=''))
```

### Variação Semanal em 2020 e 2021 de Uva Branca Embalada {.no-title}

```{r palmer 5, results='', fig.cap=''}

g2 <- ggplot()+
  geom_col(data=variacao, aes(x=Semanas, y=value, fill=variable), size=2, 
           width = 0.9, position = "dodge")+
  scale_fill_manual(values=mycolors2)+
  scale_y_continuous(labels = number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Variação Percentual", x= "Semanas do Ano", title='Variação Semanal de preços de Uva Branca Embalada',
       caption = "Fonte: Observatório de Mercado de Uva da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.4, 
                      y=-0.25,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Preço e Tendência de Uva Branca Embalada {.no-title}

```{r branca2, results='', fig.cap=''}
#Gráfico com Ggplot2

g3 <- ggplot(data=arra, aes(x=date)) +  #estetica vai valer para todos os geom's
  geom_line(aes(y=preco_def, colour="PREÇO"), lwd=0.5)+
  geom_line(aes(y=sazonal_arra, colour="TENDÊNCIA"), lwd=1)+
  scale_colour_manual("", 
                      breaks = c("PREÇO", "TENDÊNCIA"),
                      values = c("black", "tomato")) +
  labs(y= "Preço R$", x= "Semanas de cada Ano", title='Evolução dos preços ao produtor e Tendência Uva Branca Embalada',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Uva da Embrapa") +
  scale_y_continuous(limits=c(0,18), n.breaks = 10, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_date(date_breaks = "1 year",
               labels = date_format("%Y"))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=10)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = c(2,1),
        legend.justification = c(1.2, 1.2),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.25,
                      title=''))
```

### Sazonalidade de Uva Branca Embalada {.no-title}

```{r branca3, results='', fig.cap='', fig.align='center'}
#Decompor a Série

decompa<-decompose(preco_arra, type = 'multiplicative')

sazonalidade <- decompa$figure
semanas <- seq(1:52)
sazonal_graph <- tibble(cbind(semanas, sazonalidade))


g4 <- ggplot(data=sazonal_graph)+
  geom_line(aes(x=semanas, y=sazonalidade), color="darkmagenta", size=1.2)+
  scale_y_continuous(limits=c(0,1.5), n.breaks = 5, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "", x= "Semanas de cada Ano", title='Sazonalidade do preço de Uva Branca Embalada',
       caption = "Fonte: Observatório de Mercado de Uva da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.05, 
                      y=-0.25,
                      title=''))
```

NEGRA SEEDLESS EMBALADA {data-navmenu="PREÇOS AO PRODUTOR"}
======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### Preço de Uva Negra Embalada na Semana `r strftime(data, format = "%V")` de 2022 
``` {r}
num <- tail(preco_vitoria,1)
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  color = "tomato",
  icon= "fa-arrow-down")
```

### Preço de Uva Negra Embalada na Semana `r strftime(data, format = "%V")` de 2021
``` {r}
num <- 8.17
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  icon= "fa-pen")
```

### Preço de Uva Negra Embalada na Semana `r strftime(data, format = "%V")` de 2020
``` {r}
num <-11.94
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Mínimo, Máximo, Media e preços de 2020 a 2022 de Uva Negra Embalada {.no-title}

```{r negra_setup}

#Analise das comparações entre as médias
preco_vitoria_2019 <- window(preco_vitoria, end=c(2019,52))
seas19<-seasplot(preco_vitoria_2019, trend=F, outplot = F)
medias19 <- colMeans(seas19$season)

preco_vitoria_2020 <- window(preco_vitoria, end=c(2020,52))

preco_vitoria_2021 <- window(preco_vitoria, end=c(2021,52))
#seas21<-seasplot(preco_palmer_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

preco_vitoria_22 <- as.matrix(tail(vitoria$preco_def,sem_ano))
preco_vitoria_2022 <- matrix(NA, nrow=52, ncol=1)

for(i in 1:sem_ano){
  preco_vitoria_2022[i,1] = preco_vitoria_22[i,1]
}
  
#Como só se tem até a semana 52
medias19 <- medias19[1:52]
#medias21 <- medias21[1:52]

matrix = matrix(NA, nrow=52, ncol=2)

for(i in 1:52){
  matrix[i,1] = min(seas19$season[,i])
  matrix[i,2] = max(seas19$season[,i])
}

time <- seq(1:52)
table <- data.frame(time, matrix[,1], round(medias19,2), matrix[,2], round(tail(preco_vitoria_2020,52),2),
                    round(tail(preco_vitoria_2021,52),2), preco_vitoria_2022[,1])
colnames(table) = c('Semanas', 'Mínimo', 'Média', 'Máximo', '2020', '2021', 
                    '2022')
tablea <- table[,-c(5:7)]
tableb <- table[,-c(2,3,4)]

tablea2 <- melt(tablea, id.var='Semanas')
tableb2 <- melt(tableb, id.var='Semanas')
mycolors <- c("dodgerblue2", "gold", "darkmagenta")
```

```{r negra1, results='', fig.cap='', fig.width=8, fig.height=4, fig.align='center'}

g5 <- ggplot()+
  geom_col(data=tableb2, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.7,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
    geom_line(data=tablea2, aes(x=Semanas, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
  scale_y_continuous(limits = c(0, 20), n.breaks = 10, labels = number_format(accuracy = 0.01,
                                                       decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Preço R$", x= "Semanas de cada Ano", title='Mínimo, Máximo, Média e preços de 2020 a 2022 de Uva Negra Embalada',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Uva da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g5) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.05, 
                      y=1.1,
                      title=''))
```

### Variação Semanal em 2020 e 2021 de Uva Negra Embalada {.no-title}

```{r negra2, results='', fig.cap=''}

#Parte 4

preco_vitoria_21 <- vitoria %>% filter(ano=='2021')
preco_vitoria_2021 <- as.matrix(preco_vitoria_21$preco_def)
variacao_21 <- (preco_vitoria_2021/lag(preco_vitoria_2021, 1) - 1)*100

variacao_22 <- (preco_vitoria_2022/lag(preco_vitoria_2022, 1) - 1)*100

semanas <- seq(1:52)
variacao <- data.frame(semanas, variacao_21[,1], variacao_22[,1])
colnames(variacao) = c('Semanas', '2021', '2022')

variacao <- melt(variacao, id.var='Semanas')

mycolors2 <- c("orange", "lightblue3")


g6 <- ggplot()+
  geom_col(data=variacao, aes(x=Semanas, y=value, fill=variable), size=2, 
           width = 0.9, position = "dodge")+
  scale_fill_manual(values=mycolors2)+
  scale_y_continuous(labels = number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Variação Percentual", x= "Semanas do Ano", title='Variação Semanal de preços de Uva Negra Embalada',
       caption = "Fonte: Observatório de Mercado de Uva da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g6) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.4, 
                      y=-0.25,
                      title=''))
```


Row
-----------------------------------------------------------------------

### Preço e Tendência de Uva Negra Embalada {.no-title}

```{r negra3, results='', fig.cap=''}
#Gráfico com Ggplot2

g7 <- ggplot(data=vitoria, aes(x=date)) +  #estetica vai valer para todos os geom's
  geom_line(aes(y=preco_def, colour="PREÇO"), lwd=0.5)+
  geom_line(aes(y=sazonal_vitoria, colour="TENDÊNCIA"), lwd=1)+
  scale_colour_manual("", 
                      breaks = c("PREÇO", "TENDÊNCIA"),
                      values = c("black", "tomato")) +
  labs(y= "Preço R$", x= "Semanas de cada Ano", title='Evolução dos preços ao produtor e Tendência Uva Negra Embalada',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Uva da Embrapa") +
  scale_y_continuous(limits=c(0,20), n.breaks = 10, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_date(date_breaks = "1 year",
               labels = date_format("%Y"))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=10)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = c(2,1),
        legend.justification = c(1.2, 1.2),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g7) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.25,
                      title=''))
```

### Sazonalidade de Uva Negra Embalada {.no-title}

```{r negra4, results='', fig.cap='', fig.align='center'}
#Decompor a Série
decompa<-decompose(preco_vitoria, type = 'multiplicative')

sazonalidade <- decompa$figure
semanas <- seq(1:52)
sazonal_graph <- tibble(cbind(semanas, sazonalidade))


g8 <- ggplot(data=sazonal_graph)+
  geom_line(aes(x=semanas, y=sazonalidade), color="darkmagenta", size=1.2)+
  scale_y_continuous(limits=c(0,1.5), n.breaks = 5, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "", x= "Semanas de cada Ano", title='Sazonalidade do preço de Uva Negra Embalada',
       caption = "Fonte: Observatório de Mercado de Uva da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g8) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.05, 
                      y=-0.25,
                      title=''))
```

NEGRA SEEDLESS {data-navmenu="PREÇOS AO PRODUTOR"}
======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### Preço de Uva Negra na Semana `r strftime(data, format = "%V")` de 2022 
``` {r}
num <- tail(preco_vitoriase,1)
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  color = "tomato",
  icon= "fa-arrow-down")
```

### Preço de Uva Negra na Semana `r strftime(data, format = "%V")` de 2021
``` {r}
num <- 4.64
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  icon= "fa-pen")
```

### Preço de Uva Negra na Semana `r strftime(data, format = "%V")` de 2020
``` {r}
num <-6.94
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Mínimo, Máximo, Media e preços de 2020 a 2022 de Uva Negra {.no-title}

```{r negrase_setup}

#Analise das comparações entre as médias
preco_vitoriase_2020 <- window(preco_vitoriase, end=c(2020,52))
seas20<-seasplot(preco_vitoriase_2020, trend=F, outplot = F)
medias20 <- colMeans(seas20$season)

preco_vitoriase_2021 <- window(preco_vitoriase, end=c(2021,52))
#seas21<-seasplot(preco_palmer_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

preco_vitoriase_22 <- as.matrix(tail(vitoriase$preco_def,sem_ano))
preco_vitoriase_2022 <- matrix(NA, nrow=52, ncol=1)

for(i in 1:sem_ano){
  preco_vitoriase_2022[i,1] = preco_vitoriase_22[i,1]
}
  
#Como só se tem até a semana 52
medias20 <- medias20[1:52]
#medias21 <- medias21[1:52]

matrix = matrix(NA, nrow=52, ncol=2)

for(i in 1:52){
  matrix[i,1] = min(seas20$season[,i])
  matrix[i,2] = max(seas20$season[,i])
}

time <- seq(1:52)
table <- data.frame(time, matrix[,1], round(medias20,2), matrix[,2], round(tail(preco_vitoriase_2020,52),2),
                    round(tail(preco_vitoriase_2021,52),2), preco_vitoriase_2022[,1])
colnames(table) = c('Semanas', 'Mínimo', 'Média', 'Máximo', '2020', '2021', 
                    '2022')
tablea <- table[,-c(5:7)]
tableb <- table[,-c(2,3,4)]

tablea2 <- melt(tablea, id.var='Semanas')
tableb2 <- melt(tableb, id.var='Semanas')
mycolors <- c("dodgerblue2", "gold", "darkmagenta")
```

```{r negrase1, results='', fig.cap='', fig.align='center'}

g9 <- ggplot()+
  geom_col(data=tableb2, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.7,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
    geom_line(data=tablea2, aes(x=Semanas, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
  scale_y_continuous(limits = c(0, 12), n.breaks = 10, labels = number_format(accuracy = 0.01,
                                                       decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Preço R$", x= "Semanas de cada Ano", title='Mínimo, Máximo, Média e preços de 2021 e 2022 de Uva Negra',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Uva da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g9) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.1, 
                      y=1.1,
                      title=''))
```

### Variação Semanal em 2020 e 2021 de Uva Negra {.no-title}

```{r negrase2, results='', fig.cap=''}

#Parte 4

preco_vitoriase_21 <- vitoriase %>% filter(ano=='2021')
preco_vitoriase_2021 <- as.matrix(preco_vitoriase_21$preco_def)
variacao_21 <- (preco_vitoriase_2021/lag(preco_vitoriase_2021, 1) - 1)*100

variacao_22 <- (preco_vitoriase_2022/lag(preco_vitoriase_2022, 1) - 1)*100

semanas <- seq(1:52)
variacao <- data.frame(semanas, variacao_21[,1], variacao_22[,1])
colnames(variacao) = c('Semanas', '2021', '2022')

variacao <- melt(variacao, id.var='Semanas')

mycolors2 <- c("orange", "lightblue3")


g10 <- ggplot()+
  geom_col(data=variacao, aes(x=Semanas, y=value, fill=variable), size=2, 
           width = 0.9, position = "dodge")+
  scale_fill_manual(values=mycolors2)+
  scale_y_continuous(labels = number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Variação Percentual", x= "Semanas do Ano", title='Variação Semanal de preços de Uva Negra ao produtor',
       caption = "Fonte: Observatório de Mercado de Uva da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g10) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.4, 
                      y=-0.25,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Preço e Tendência de Uva Negra {.no-title}

```{r negrase3, results='', fig.cap=''}
#Gráfico com Ggplot2

g11 <- ggplot(data=vitoriase, aes(x=date)) +  #estetica vai valer para todos os geom's
  geom_line(aes(y=preco_def, colour="PREÇO"), lwd=0.5)+
  geom_line(aes(y=sazonal_vitoriase, colour="TENDÊNCIA"), lwd=1)+
  scale_colour_manual("", 
                      breaks = c("PREÇO", "TENDÊNCIA"),
                      values = c("black", "tomato")) +
  labs(y= "Preço R$", x= "Semanas de cada Ano", title='Evolução dos preços ao produtor e Tendência Uva Negra',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Uva da Embrapa") +
  scale_y_continuous(limits=c(0,12), n.breaks = 10, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_date(date_breaks = "1 year",
               labels = date_format("%Y"))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=10)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = c(2,1),
        legend.justification = c(1.2, 1.2),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g11) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.25,
                      title=''))
```

### Sazonalidade de Uva Negra {.no-title}

```{r negrase4, results='', fig.cap='', fig.align='center'}
#Decompor a Série

#Decompor a Série
decompa<-decompose(preco_vitoriase, type = 'multiplicative')

sazonalidade <- decompa$figure
semanas <- seq(1:52)
sazonal_graph <- tibble(cbind(semanas, sazonalidade))


g12 <- ggplot(data=sazonal_graph)+
  geom_line(aes(x=semanas, y=sazonalidade), color="darkmagenta", size=1.2)+
  scale_y_continuous(limits=c(0,1.5), n.breaks = 5, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "", x= "Semanas de cada Ano", title='Sazonalidade do preço de Uva Negra',
       caption = "Fonte: Observatório de Mercado de Uva da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g12) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.05, 
                      y=-0.25,
                      title=''))
```

EXPORTAÇÕES
======================================================================

```{r tratamento_base}
#Direcionado o R para o Diretorio a ser trabalhado
setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_uva')

#Inicio do Script
#Pacotes a serem utilizados 
library(mFilter)
library(forecast)
library(tsutils)
library(seasonal)
library(ggplot2)
library(uroot)
library(tseries)
library(ggthemes)
library(dplyr)
library(quantmod)
library(scales)
library(kableExtra)# complex tables
library(lmtest)
library(FinTS)
library(rbcb)
library(plotly)
library(DT)
library(magrittr)
library(rmarkdown)
library(reshape2)
library(rbcb)
library(tidyverse)

checkX13()

options(digits=4)

library(lubridate)
anterior <- as.Date("2022-02-01")
atual <-  as.Date("2022-03-01")
#today <- as.Date("2022-02-11")
mes <- 3

#Entrando dados no R
dados1 <- read.csv2('exportacoes_2016_2022.csv', header=T, sep=";", dec = ".")
dados1 <- dados1/1000
dados1[,1] <- seq(2016, 2022, by = 1)
colnames(dados1) = c('Ano', 'Valor', "Toneladas")
dados1 <- tibble(dados1)

#Entrando dados no R
dados2 <- read.csv2('total_exporta_uva_br.csv', header=T, sep=";", dec = ".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados2)[1]<-'ano'

#Entrando dados no R
dados3 <- read.csv2('destinos_2022.csv', header=T, sep=";", dec = ".")
colnames(dados3) = c('Paises', "Participacao")

#Entrando dados no R
dados4 <- read.csv2('via_2022.csv', header=T, sep=";", dec = ".")
colnames(dados4) = c('Vias', "Participacao")

#Entrando dados no R
dados5 <- read.csv2('uf_2022.csv', header=T, sep=";" , dec = ".")
colnames(dados5) = c('UF', "Participacao")

# Entrando dados no R
dados7 <- read.csv2('importacao.csv', header=T, sep=";" , dec = ".")
dados7 <- dados7[,-c(1,2)]
colnames(dados7) = c('Chile', 'Argentina', 'Peru')

#Ajusta para Valor
#Analise de Serie Temporal
exporta_uva_valor <- dados2[,3]
exporta_uva_valor<-exporta_uva_valor/1000
exporta_uva_valor <- ts(exporta_uva_valor, start=c(2016,1), freq=12)

#Tendencia
trend_valor <- cmav(exporta_uva_valor, outplot=F)
date <- seq(as.Date('2016-01-01'),to=atual,by='1 month') 
trend_valor <- tibble(date, trend_valor)

#Sazonalidade
decompa<-decompose(exporta_uva_valor, type = 'multiplicative')
sazonal_valor <- decompa$figure
#meses <- seq(1:12)
meses <- seq(as.Date("2021/1/1"), by = "month", length.out = 12) 
sazonal_graph <- tibble(meses, sazonal_valor)

#Comparações com os anos e entre as médias/max/min

exporta_uva_valor_2019 <- window(exporta_uva_valor, end=c(2019,12))
seas19<-seasplot(exporta_uva_valor_2019, trend=F, outplot = F)
medias19 <- colMeans(seas19$season)

exporta_uva_valor_2020 <- window(exporta_uva_valor, end=c(2020,12))

exporta_uva_valor_2021 <- window(exporta_uva_valor, end=c(2021,12))
#medias21 <- colMeans(seas21$season)

exporta_uva_valor_22 <- as.matrix(tail(exporta_uva_valor,mes)) 
exporta_uva_valor_2022 <- matrix(NA, nrow=12, ncol=1)

for(i in 1:mes){
  exporta_uva_valor_2022[i,1] = exporta_uva_valor_22[i,1]
}
  
#Como só se tem até a semana 12
medias19 <- medias19[1:12]

matrix = matrix(NA, nrow=12, ncol=2)

for(i in 1:12){
  matrix[i,1] = min(seas19$season[,i])
  matrix[i,2] = max(seas19$season[,i])
}

#time <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", #"Dezembro")
#time <-seq(1:12)
table <- data.frame(meses, matrix[,1], round(medias19,3), matrix[,2], round(tail(exporta_uva_valor_2020,12),3),
                    round(tail(exporta_uva_valor_2021,12),3), exporta_uva_valor_2022[,1])
colnames(table) = c('Meses', 'Mínimo', 'Média', 'Máximo', '2020', '2021', 
                    '2022')

tablea <- table[,-c(5:7)]
tableb <- table[,-c(2,3,4)]

tablea2 <- melt(tablea, id.var='Meses')
tableb2 <- melt(tableb, id.var='Meses')
mycolors <- c("lightblue3", "gray44", "gold")

#Ajusta para Volume
#Analise de Serie Temporal
exporta_uva_volume <- dados2[,4]
exporta_uva_volume<-exporta_uva_volume/1000  #passando de quilo para tonelada

#Ajuste para a variação Mensal do Volume

variacao_volume_20 <-  dados2 %>% filter(ano=='2020')
variacao_volume_21 <-  dados2 %>% filter(ano=='2021')
variacao_volume_22 <-  dados2 %>% filter(ano=='2022')

variacao_volume_20 <-  variacao_volume_20[,4]/1000
variacao_volume_21 <-  variacao_volume_21[,4]/1000
variacao_volume_22 <-  variacao_volume_22[,4]/1000

#Setando como uma série temporal
exporta_uva_volume <- ts(exporta_uva_volume, start=c(2016,1), freq=12)

#Tendencia
trend_volume <- cmav(exporta_uva_volume, outplot=F)
trend_volume <- tibble(date, trend_volume)

#Sazonalidade
decompa<-decompose(exporta_uva_volume, type = 'multiplicative')
sazonal_volume <- decompa$figure
sazonal_graph_volume <- tibble(meses, sazonal_volume)

#Comparações com os anos e entre as médias/max/min

exporta_uva_volume_2019 <- window(exporta_uva_volume, end=c(2019,12))
seas19_vol<-seasplot(exporta_uva_volume_2019, trend=F, outplot = F)
medias19_vol <- colMeans(seas19_vol$season)

exporta_uva_volume_2020 <- window(exporta_uva_volume, end=c(2020,12))

exporta_uva_volume_2021 <- window(exporta_uva_volume, end=c(2021,12))

exporta_uva_volume_22 <- as.matrix(tail(exporta_uva_volume,mes)) #ajustar mensalmente
exporta_uva_volume_2022 <- matrix(NA, nrow=12, ncol=1)

for(i in 1:mes){
  exporta_uva_volume_2022[i,1] = exporta_uva_volume_22[i,1]
}
  
#Como só se tem até a semana 12
medias19_vol <- medias19_vol[1:12]

matrix_vol = matrix(NA, nrow=12, ncol=2)

for(i in 1:12){
  matrix_vol[i,1] = min(seas19_vol$season[,i])
  matrix_vol[i,2] = max(seas19_vol$season[,i])
}

#time <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", #"Dezembro")
#time <-seq(1:12)
table_volume <- data.frame(meses, round(matrix_vol[,1],0), round(medias19_vol,0), round(matrix_vol[,2],0), round(tail(exporta_uva_volume_2020,12),0),
round(tail(exporta_uva_volume_2021,12),0), round(exporta_uva_volume_2022[,1],0))
colnames(table_volume) = c('Meses', 'Mínimo', 'Média', 'Máximo', '2020', '2021', 
                    '2022')

tablea_vol <- table_volume[,-c(5:7)]
tableb_vol <- table_volume[,-c(2,3,4)]

tablea2_vol <- melt(tablea_vol, id.var='Meses')
tableb2_vol <- melt(tableb_vol, id.var='Meses')


#Variação Mensal 2021

variacao_volume_2020 <- as.matrix(variacao_volume_20)
variacao_volume_2021 <- as.matrix(variacao_volume_21)
variacao_volume_2022 <- matrix(NA, nrow=12, ncol=1)
variacao_volume_22 <- as.matrix(variacao_volume_22)

for(i in 1:mes){
  variacao_volume_2022[i,1] = variacao_volume_22[i,1]
}

variacao_21 <- ((variacao_volume_2021/variacao_volume_2020) - 1)*100
variacao_22 <- ((variacao_volume_2022/variacao_volume_2021) - 1)*100

variacao <- data.frame(meses, variacao_21, variacao_22)
colnames(variacao) = c('Meses', 'Variação 2021 e 2020', 'Variação 2022 e 2021')

variacaom <- melt(variacao, id.var='Meses')

mycolors2 <- c("orange", "lightblue3")

#Dados de Importação
importacao <- tibble(date, dados7)
importacao <- melt(importacao, id.var='date')
```

Row {data-height=125}
-----------------------------------------------------------------------

### Volume Exportação em `r strftime(atual, format = "%B")` de 2022 
``` {r d1}
num <- 603
valueBox(
  value = paste0(num, " Toneladas"),
  color = "tomato",
  icon= "fa-arrow-down")
```

### Volume Exportação em `r strftime(atual, format = "%B")` de 2021 
``` {r d2}
num <- 3789
valueBox(
  value = paste0(num, " Toneladas"),
  icon= "fa-pen")
```

### Volume Exportação em `r strftime(atual, format = "%B")` de 2020 
``` {r d3}
num <- 1668
valueBox(
  value = paste0(num, " Toneladas"),
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Receita de Exportação e Volume Exportado de Uva: 2016 a 2022 {.no-title}

```{r exporta1, fig.width=8, fig.height=4, fig.align='center'}

#Gráfico com Ggplot2

mycolor1 <- "gold"
mycolor2 <- "red"

g1 <- ggplot(data=dados1) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=Ano, y=Toneladas, fill="Mil Toneladas"), lwd=1)+
    scale_fill_manual(values=mycolor1)+
  geom_line(aes(x=Ano, y=Valor, colour="Milhões de Dólares"), size=2)+
  scale_colour_manual(values=mycolor2)+
  labs(y= "US$ Mil / Ton", x= "Anos", title='Receita de Exportação e Volume Exportado de Uva: 2016 a 2022',
       caption = "") +
  scale_y_continuous(limits=c(0, 160000), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2016, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.25, 
                      y=-0.2,
                      title=''))
```

### Principais Destinos da Uva Exportada em Janeiro de 2022 {.no-title}

```{r exporta15, fig.width=7, fig.height=4, fig.align='center'}

#Gráfico com Ggplot2

mycolor1 <- "gold"

g10 <- ggplot(data=dados3) +  #estetica vai valer para todos os geom's
  geom_col(aes(x = reorder(Paises, -Participacao), y= Participacao, fill="% do Total"), lwd=1)+
    scale_fill_manual(values=mycolor1) +
  labs(y= "% do Volume Total Exportados", x= "Países", title='Principais Destinos da Uva',
       caption = "")+
  scale_y_continuous(limits=c(0, 50), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g10) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.4, 
                      y=-0.2,
                      title=''))
```

### Principais vias de exportação da uva do Brasil: Janeiro de 2022. {.no-title}

```{r exporta17}

#Gráfico com Ggplot2

g11 <- ggplot(data=dados4) +  #estetica vai valer para todos os geom's
  geom_col(aes(x = reorder(Vias, -Participacao), y= Participacao, fill="% do Total"), lwd=1)+
    scale_fill_manual(values=mycolor1) +
  labs(y= "% de Exportação", x= "Vias", title='Principais vias de exportação',
       caption = "")+
  scale_y_continuous(limits=c(0, 100), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g11) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.4, 
                      y=-0.2,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Volume das Exportações de Uva do Brasil: Janeiro de 2022 em comparação com as informações entre 2016-2021 {.no-title}

```{r exporta9, fig.width=10, fig.height=4, fig.align='center'}
g7 <- ggplot()+
  geom_col(data=tableb2_vol, aes(x=Meses, y=value, fill=variable), lwd=1,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
  geom_line(data=tablea2_vol, aes(x=Meses, y=value, colour=variable), linetype = "solid",
            size = 1)+
    scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
    scale_y_continuous(limits = c(0, 25000), n.breaks = 10)+
    scale_x_date(date_breaks = "1 month",
               labels = date_format("%B"))+
  labs(y= "Toneladas", x= "Meses do Ano", title='Exportações de Uva do Brasil: valores e estatísticas mensais.',
       caption = "")+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g7) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.1, 
                      y=1,
                      title=''))
```

### Importação de Uva pelo Brasil: 2016-2022. {.no-title}

``` {r importa1}
mycolors3 <- c("orange", "lightblue3", "red")

g13 <- ggplot()+
geom_col(data=importacao, aes(x=date, y=value, fill=variable), lwd=1, position = "dodge")+
  scale_fill_manual(values=mycolors3)+
    scale_x_date(date_breaks = "6 months",
               labels = date_format("%b-%y"))+
  labs(y= "Volume (Toneladas)", x= "Meses do Ano", title='Importações de Uva do Brasil: valores e estatísticas mensais.',
       caption = "Fonte: COMEXSTAT reprocessado pelo Observatório de Mercado de Uva da Embrapa")+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g13) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.2,
                      title=''))
```

MERCADO INTERNO
======================================================================

```{r database4}
#Direcionado o R para o Diretorio a ser trabalhado
setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_uva')

#Inicio do Script
#Pacotes a serem utilizados
library(mFilter)
library(forecast)
library(tsutils)
library(seasonal)
library(ggplot2)
library(uroot)
library(tseries)
library(ggthemes)
library(dplyr)
library(tidyverse)
library(quantmod)
library(scales)
library(kableExtra)# complex tables
library(lmtest)
library(FinTS)
library(magrittr)# pipe operations
library(readxl)
library(reshape2)
library(plotly)
library(DT)

checkX13()

options(digits=4)

today <- as.Date("2022-02-11")
atual <-  as.Date("2022-02-01")
mes <- 2

#Dados de uva por estados

dados3 <- read_excel("ceasas_mi_total22.xlsx", col_names = FALSE)
dados3 <- dados3[,-1]

#Transpor a base de dados
dados3 <- as.data.frame(t(dados3))
colnames(dados3) <-c ('ano','produto','unidade','quilos')
dados3 <- dados3 %>%
  mutate(quilos=as.numeric(quilos))

#Total de uvas em todos os CEASAS todas as UF

uva_anual_all <- dados3 
uva_anual_all$todas_UF <- (uva_anual_all$quilos)/1000 #transformando em Toneladas
uva_anual_all <- uva_anual_all[,-2]

#Total de uvas em todos os CEASAS PE + BA

dados4 <- read_excel("ceasas_mi_peba22.xlsx", col_names = FALSE)
dados4 <- dados4[,-1]
dados4 <- as.data.frame(t(dados4))
colnames(dados4) <-c ('ano','produto','origem','unidade','quilos')

dados4 <- dados4 %>%
  mutate(quilos=as.numeric(quilos))

uva_anual_pe <- dados4 %>% filter(origem=='PE')
uva_anual_ba <- dados4 %>% filter(origem=='BA')

uva_total_peba <- tibble(uva_anual_pe$quilos + uva_anual_ba$quilos)
uva_total_peba <- uva_total_peba/1000 #passando o volume para toneladas
colnames(uva_total_peba)[1]<-'pe+ba'

#Juntando as bases de dados Total e PEBA

uva_anual_all <- tibble(uva_anual_all, uva_total_peba)
uva_anual_all$ano <- seq(as.Date('2017-01-01'),to=today,by='1 year')
uva_anual_all <- uva_anual_all[,-c(2:3)]
uva_anual_allm <- melt(uva_anual_all, id.var='ano')

# Variação da oferta

dados5 <- read_excel("ceasas_mi_peba_mensal22.xlsx", col_names = FALSE)
dados5 <- dados5[,-1]

#Transpor a base de dados
dados5 <- as.data.frame(t(dados5))
colnames(dados5) <-c ('ano','produto','mes','origem','unidade','quilos')
dados5 <- dados5 %>%
  mutate(quilos=as.numeric(quilos))

# Geração da variável Tommy
uva_mespe <-  dados5 %>%
  filter(origem == "PE")

uva_mesba <-  dados5 %>%
  filter(origem == "BA")

uva_mespeba <- tibble((uva_mespe$quilos + uva_mesba$quilos)/1000)
uva_mespeba$mes <- seq(as.Date('2017-01-01'),to=atual,by='1 month')
uva_mespeba$ano <- uva_mespe$ano
colnames(uva_mespeba)[1] <-'toneladas'

totalpeba_20 <- uva_mespeba %>% filter(ano=='2020')
totalpeba_21 <- uva_mespeba %>% filter(ano=='2021')
totalpeba_22 <- uva_mespeba %>% filter(ano=='2022')

totalpeba_var20 <- as.matrix(totalpeba_20$toneladas)
totalpeba_var21 <- as.matrix(totalpeba_21$toneladas)
totalpeba_var22 <- matrix(NA, nrow=12, ncol=1)
totalpeba_var222 <-  as.matrix(totalpeba_22$toneladas)

#Calculo das variações
variacaopeba_2120 <- ((totalpeba_var21/totalpeba_var20)-1)*100

# Para 2022 comparando com 2021
for(i in 1:mes){
  totalpeba_var22[i,1] = totalpeba_var222[i,1]
}

variacaopeba_2221 <- ((totalpeba_var22/totalpeba_var21)-1)*100

#meses <- seq(1:12)
variacao_totalpeba <- data.frame(date2, variacaopeba_2120, variacaopeba_2221)
colnames(variacao_totalpeba) = c('Meses', 'Ano 2021', 'Ano 2022')

variacao_totalpebat <- melt(variacao_totalpeba, id.var='Meses')

#Tendencia PEBA
uva_mespeba2 <- ts(uva_mespeba$toneladas, start = c(2017,1), freq=12)
trend_peba <- cmav(uva_mespeba2, outplot=F)

#Sazonalidade PEBA
decompa_peba<-decompose(uva_mespeba2, type = 'multiplicative')
sazonal_peba <- decompa_peba$figure
meses <- seq(as.Date("2021/1/1"), by = "month", length.out = 12)
sazonalpeba_graph <- tibble(meses, sazonal_peba)


#Comparações com os anos e entre as médias/max/min

peba_2019 <- window(uva_mespeba2, end=c(2019,12))
seaspeba_19<-seasplot(peba_2019, trend=F, outplot = F)
mediaspeba_19 <- colMeans(seaspeba_19$season)

peba_2020 <- window(uva_mespeba2, end=c(2020,12))

peba_2021 <- window(uva_mespeba2, end=c(2021,12))
#seas21<-seasplot(preco_palmer_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

peba_22 <- as.matrix(tail(uva_mespeba2,mes)) #ajustar mensalmente
peba_2022 <- matrix(NA, nrow=12, ncol=1)

for(i in 1:mes){
  peba_2022[i,1] = peba_22[i,1]
}

#Como só se tem até a semana 12
mediaspeba_19 <- mediaspeba_19[1:12]

matrixpeba = matrix(NA, nrow=12, ncol=2)

for(i in 1:12){
  matrixpeba[i,1] = min(seaspeba_19$season[,i])
  matrixpeba[i,2] = max(seaspeba_19$season[,i])
}

#time <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", #"Dezembro")
#time <-seq(1:12)
table_peba <- data.frame(meses, matrixpeba[,1], round(mediaspeba_19,1), matrixpeba[,2],
                         round(tail(peba_2020,12),1),
                    round(tail(peba_2021,12),1), peba_2022[,1])
colnames(table_peba) = c('Meses', 'Mínimo', 'Média', 'Máximo', '2020', '2021',
                    '2022')

tablepeba_a <- table_peba[,-c(5:7)]
tablepeba_b <- table_peba[,-c(2,3,4)]

tablepeba_a2 <- melt(tablepeba_a, id.var='Meses')
tablepeba_b2 <- melt(tablepeba_b, id.var='Meses')
mycolors <- c("lightblue3", "gray44", "gold")
mycolor1 <- "gold"
mycolors2 <- c("orange", "lightblue3")
```

Row {data-height=125}
-----------------------------------------------------------------------

### Volume Comercializado (CEASAS) em `r strftime(atual, format = "%B")` de 2022 
``` {r v1}
num <- 4137.5
valueBox(
  value = paste0(num, " Toneladas"),
  color = "tomato",
  icon= "fa-arrow-down")
```

### Volume Comercializado (CEASAS) em `r strftime(atual, format = "%B")` de 2021 
``` {r v2}
num <- 5046.2
valueBox(
  value = paste0(num, " Toneladas"),
  icon= "fa-pen")
```

### Volume Comercializado (CEASAS) em `r strftime(atual, format = "%B")` de 2020 
``` {r v3}
num <- 4261.9
valueBox(
  value = paste0(num, " Toneladas"),
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Volume total comercializado de uva: 2017 a 2022 {.no-title}

```{r mi1}
## Gráfico Total de uvas e uvas PE+BA

g1 <- ggplot()+
  geom_col(data=uva_anual_allm, aes(x=ano, y=value, fill=variable), lwd=1, position = "dodge")+
  scale_fill_manual(values=mycolors2)+
  scale_y_continuous(limits = c(0, 150000), n.breaks = 10)+
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y"))+
  labs(y= "Toneladas", x= "Anos", title='',
       caption = "Fonte: PROHORT/CONAB reprocessado pelo Observatório de Mercado de uva da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=14, margin = margin(b=20)),
        axis.text.y=element_text(hjust=0.5, size=14, margin = margin(l=20)),
        axis.title.y = element_text(size=16, face = "bold"),
        axis.title.x = element_text(size=16, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=14),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.30, 
                      y=-0.30,
                      title=''))
```

### Tendência do Volume comercializado de uva {.no-title}

```{r mi3}
#Gráfico com Ggplot2 - Tendencia

g3 <- ggplot(data=uva_mespeba, aes(x=mes)) +  #estetica vai valer para todos os geom's
  geom_line(aes(y=toneladas, colour="TONELADAS"), lwd=1)+
  geom_line(aes(y=trend_peba, colour="TENDÊNCIA"), lwd=1)+
  scale_colour_manual("",
                      breaks = c("TONELADAS", "TENDÊNCIA"),
                      values = c("blue", "red")) +
  labs(y= "Quantidade (T)", x= "Meses do Ano", title='',
       caption = "Fonte: CONAB reprocessado pelo Observatório de Mercado de uva da Embrapa")+
  scale_y_continuous(limits=c(0,12000), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  scale_x_date(date_breaks = "1 year",
               labels = date_format("%Y"))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=14, margin = margin(b=10)),
        axis.text.y=element_text(hjust=1, size=14, margin = margin(l=20)),
        axis.title.x = element_text(size=16, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=16, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=16, face="italic"),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.30, 
                      y=-0.30,
                      title=''))
```

### Sazonalidade do Volume comercializado de uva {.no-title}

```{r mi4}
# Gráfico da Sazonalidade

g4 <- ggplot(data=sazonalpeba_graph)+
  geom_line(aes(x=meses, y=sazonal_peba), color="blue", size=1.5)+
  scale_y_continuous(limits=c(0,1.5), n.breaks = 5, expand = expansion(add=c(0,0.5)),
                     labels=number_format(accuracy = 0.1)) +
  scale_x_date(date_breaks = "1 month",
               labels = date_format("%b"))+
  labs(y= "", x= "Meses de cada Ano", title='',
       caption = "Observatório de Mercado de uva da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=14, margin = margin(b=20)),
        axis.text.y=element_text(hjust=0.5, size=14, margin = margin(l=20)),
        axis.title.y = element_text(size=14, face = "bold"),
        axis.title.x = element_text(size=14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=14),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.30, 
                      y=-0.25,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Estatísticas sobre a Evolução da Oferta de uva {.no-title}

```{r mi5}
#Evolução da Oferta Mensal de uva PEBA nos CEASAS do Brasil

g5 <- ggplot()+
  geom_col(data=tablepeba_b2, aes(x=Meses, y=value, fill=variable), lwd=1,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
  geom_line(data=tablepeba_a2, aes(x=Meses, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
  scale_y_continuous(limits = c(0, 12000), n.breaks = 10)+
  scale_x_date(date_breaks = "1 month",
               labels = date_format("%B"))+
  labs(y= "Toneladas", x= "Meses do Ano", title='',
       caption = "")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=12, margin = margin(b=20)),
        axis.text.y=element_text(hjust=0.5, size=14, margin = margin(l=20)),
        axis.title.y = element_text(size=14, face = "bold"),
        axis.title.x = element_text(size=14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=14),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=11)) # Definindo posição da legenda

ggplotly(g5) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.05, 
                      y=-0.35,
                      title=''))
```

### Variação do Volume comercializado de uva: 2017 a 2022 {.no-title}

```{r mi2}
#Variação Volume PE+BA

g2 <- ggplot()+
  geom_col(data=variacao_totalpebat, aes(x=Meses, y=value, fill=variable), lwd=1, position = "dodge")+
  scale_fill_manual(values=mycolors2)+
  scale_y_continuous(limits = c(-20, 100), n.breaks = 10)+
  scale_x_date(date_breaks = "1 month",
               labels = date_format("%B"))+
  labs(y= "Variação Percentual (%)", x= "Meses do Ano", title='',
       caption = "Fonte: Observatório de Mercado de uva da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=14, margin = margin(b=20)),
        axis.text.y=element_text(hjust=0.5, size=14, margin = margin(l=20)),
        axis.title.y = element_text(size=16, face = "bold"),
        axis.title.x = element_text(size=16, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=14),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.30,
                      title=''))
```

EMPREGO
======================================================================

```{r database6}
#Direcionado o R para o Diretorio a ser trabalhado
setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_caged')

anterior <- as.Date("2022-02-01")
atual <-  as.Date("2022-02-01")
#today <- as.Date("2022-02-11")
today <- as.Date("2022-03-31")

#Inicio do Script
#Pacotes a serem utilizados 
library(ggplot2)
library(scales)
library(plotly)

#Entrando dados no R
dados1 <- read.csv2('fevereiro_2022.csv', header=T, sep=";", dec = ".")
colnames(dados1)[1] <- 'date'
dados1$date <- seq(as.Date('2021-01-01'),to=anterior,by='1 month')

#Entrando com o restante dos dados

load("fevereiro_22_caged.RData")

#dados_01_vsf$sexo <- lapply(dados_01_vsf$sexo, factor)

dados_01_vsf$sexo[dados_01_vsf$sexo == 1] <- 0
dados_01_vsf$sexo[dados_01_vsf$sexo == 3] <- 1

dados_01_vsf <- mutate(dados_01_vsf,
                sexo = factor(sexo, levels = 0:1, labels = c("Masculino", "Feminino")))

# Mantendo apenas 

#Separando as admissoes e as demissoes
dados_01_vsf_positivos <-dados_01_vsf%>% filter(saldo_movim=="1")
dados_01_vsf_negativos <-dados_01_vsf%>% filter(saldo_movim=="-1")

#Mantendo apenas o agronegocio
secao_positivos <-dados_01_vsf_positivos%>% filter(secao=="A")
secao_negativos <-dados_01_vsf_negativos%>% filter(secao=="A")

#Mantendo apenas a uva
subclasse_positivos <-dados_01_vsf_positivos%>% filter(subclasse=="132600")
subclasse_negativos <-dados_01_vsf_negativos%>% filter(subclasse=="132600")

subclasse_positivos <- mutate(subclasse_positivos,
                grau_instrucao = factor(grau_instrucao, levels = 1:13, 
                                        labels = c("Analfabeto",
                                                   "Até 5ª Incompleto",
                                                   "5ª Completo Fundamental",
                                                   "6ª a 9ª Fundamental",
                                                   "Fundamental Completo",
                                                   "Médio Incompleto",
                                                   "Médio Completo",
                                                   "Superior Incompleto",
                                                   "Superior Completo",
                                                   "Mestrado",
                                                   "Doutorado",
                                                   "Pós-Graduação completa",
                                                   "Não Identificado")))
```

Row {data-height=125}
-----------------------------------------------------------------------

### pela viticultura em `r strftime(atual, format = "%B")` de 2022 
``` {r emp1}
num <- 1903
valueBox(
  value = paste0(num, " Contratados"),
  color = "green",
  icon= "fa-arrow-up")
```

### pela viticultura em `r strftime(atual, format = "%B")` de 2022 
``` {r emp2}
num <- 1295
valueBox(
  value = paste0(num, " Demitidos"),
  color = "tomato",
  icon= "fa-arrow-down")
```

### Saldo Gerado pela viticultura em `r strftime(atual, format = "%B")` de 2022 
``` {r emp3}
num <- 608
valueBox(
  value = paste0(num, " Empregos"),
  color = "green",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Evolução do saldo de Empregos gerados na viticultura {.no-title}

```{r emp4}
#Gráfico com Ggplot2

mycolor1 <- "gold"

g1 <- ggplot(data=dados1) +  #estetica vai valer para todos os geom's
  geom_col(aes(x=date, y=Saldo_uva, fill="Saldo Uva"), lwd=1)+
    scale_fill_manual(values=mycolor1)+
    labs(y= "Saldo de Emprego (unidade)", x= "Meses do Ano", title='Evolução do saldo de Empregos gerados na viticultura',
       caption = "")+
    scale_y_continuous(limits=c(-2700, 2200), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
    scale_x_date(date_breaks = "1 month", expand=c(0,0),
               labels = date_format("%b/%y"))+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=10, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=5)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_blank()) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.45, 
                      y=-0.25,
                      title=''))
```

### Empregos gerados na uva por gênero {.no-title}

``` {r emp5}
### Histograma

g2 <- ggplot(data = subclasse_positivos, aes(x = sexo, y = ..count..)) +
  geom_bar(fill='steelblue')+
    labs(y= "Contratados Uva - VSF", x= "Gênero", title='Distribuição dos empregos gerados por gênero',
       caption = "")+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2)
```

Row
-----------------------------------------------------------------------

### Empregos gerados na uva por idade {.no-title}

``` {r emp6}
### Histograma

g3 <- ggplot(data=subclasse_positivos, aes(x=idade))+
  geom_histogram(binwidth=3, fill="#69b3a2", color="#e9ecef", alpha=0.9)+
    labs(y= "Contratados Uva - VSF", x= "Idades", title='Distribuição dos empregos gerados por idade',
       caption = "")+
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda
  
ggplotly(g3)
``` 


### Empregos gerados na uva por grau de instrução {.no-title}

``` {r emp7}
### Histograma

g4 <- ggplot(data = subclasse_positivos, aes(x = grau_instrucao, y = ..count..)) +
  geom_bar(fill='#1e4971')+
    scale_y_continuous(limits=c(0, 900), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
labs(y= "Contratados Uva - VSF", x= "Grau de Instrução", title='Grau de Instrução dos empregos gerados',
       caption = "")+
  theme_minimal() +
  theme(axis.text.x=element_text(angle=30, hjust=1, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda
  
ggplotly(g4)
```

