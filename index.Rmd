---
title: "DASHBOARD MERCADO DE MANGA"
#author: "João Ricardo Lima"
output: 
  flexdashboard::flex_dashboard:
    logo: "https://raw.githubusercontent.com/observatoriosdemercado/manga/main/branca_peq.png"
    favicon: "https://www.embrapa.br/portal-embrapa-theme/images/marca-embrapa-colorida.png"
    navbar:
      - {title: "Apoio, Metodologia e Fontes dos Dados", href: "https://observatoriosdemercado.github.io/manga/fonte/", align: right}
    orientation: rows
    vertical_layout: fill #sem barra de rolagem e scroll com barra
    theme: 
      version: 4
      bootswatch: bootstrap
      navbar-bg: "#183b8c"
      fg:        "#183b8c"
      bg:        "#ffffff"
#runtime: shiny    
---

```{r setup, include=FALSE}
library(flexdashboard)
library(foreign)
library(mFilter)
library(forecast)
library(dplyr)
library(tsutils)
library(xts)
library(ggthemes)
library(FinTS)
library(scales)
library(ggplot2)
library(reshape)
library(reshape2)
library(imputeTS)
library(seasonal)
library(uroot)
library(tseries)
library(quantmod)
library(kableExtra)# complex tables
library(lmtest)
library(plotly)
#library(rmarkdown)
library(bslib)
#library(shiny)

knitr::opts_chunk$set(
  echo       = FALSE,
  warning    = FALSE,
  message    = FALSE,
  fig.align  = "left",
  comment    = "#"
  )

library(lubridate)
data <- as.Date("2024-05-10") #ajustar semanalmente
sem_ano <- 19 #ajustar semanalmente

# Linhas que precisam de ajuste: 71, 104, 107
```

BRASIL {data-navmenu="DADOS GERAIS"}
======================================================================

```{r database5}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Inicio do Script
#Pacotes a serem utilizados
library(mFilter)
library(forecast)
library(tsutils)
library(seasonal)
library(ggplot2)
library(uroot)
library(tseries)
library(ggthemes)
library(dplyr)
library(tidyverse)
library(quantmod)
library(scales)
library(kableExtra)# complex tables
library(lmtest)
library(FinTS)
library(magrittr)# pipe operations
library(readxl)
library(reshape2)
library(plotly)
#library(rmarkdown)
library(bslib)
library(gridExtra)# multiple grid-based plots on a page
library(patchwork)

checkX13()

options(digits=4)
#today <- as.Date("2022-01-01")
date <- seq(as.Date('2022-01-01'),to=as.Date('2022-12-01'),by='1 month')

#Entrando dados no R
dados <- read_excel("manga_ibge2022.xlsx", col_names = TRUE)
dados$produtividade <- round(dados$produtividade,0)

#Gráfico com Ggplot2 Palmer

mycolor1 <- "gold"
mycolor2 <- "darkgreen"
mycolor3 <- "blue"
mycolor4 <- "red"
```

Row {data-height=125}
-----------------------------------------------------------------------

### Área Plantada com Manga no Brasil em 2022 
``` {r}
num <- 78.3 
valueBox(
  value = paste0(num, " Mil Hectares"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Produtividade média da Manga no Brasil em 2022 
``` {r}
num <- 20
valueBox(
  value = paste0( num, " Toneladas/Hectare"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Volume com Manga produzida no Brasil em 2022 
``` {r}
num <- 1.55
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Milhões de Toneladas" ),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Valor Produção com Manga produzida no Brasil em 2022 
``` {r}
num <- 2.07
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Bilhões de Reais" ),
#  color = "lightblue3",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Area Plantada com Manga - Brasil {.no-title}

```{r ibge1}
g1 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=area, fill="Area Manga (Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor1)+
  labs(y= "Hectares", x= "Anos", title='Evolução da Área com Manga no Brasil: 2013-2022',
       caption = "Fonte: IBGE (2023)") +
  scale_y_continuous(limits=c(0, 80000), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12))

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

### Volume Produzido de Manga -  Brasil {.no-title}

```{r ibge2}
g2 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=quantidade/1000, fill="Volume (Mil Toneladas)"), lwd=1)+
  scale_fill_manual(values=mycolor2)+
  labs(y= "Mil Toneladas", x= "Anos", title='Evolução do Volume com Manga no Brasil: 2013-2022',
       caption = "Fonte: IBGE (2023)") +
  scale_y_continuous(limits=c(0, 1600), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Produtividade da Manga - Brasil {.no-title}

```{r ibge3}
g3 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=produtividade, fill="Produtividade (Toneladas/Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor3)+
  labs(y= "Produtividade (Ton/Ha)", x= "Anos", title='Evolução da Produtividade com Manga no Brasil: 2013-2022',
       caption = "IBGE (2023)") +
  scale_y_continuous(limits=c(0, 25), n.breaks = 5, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

### Valor Bruto da Produção com Manga -  Brasil {.no-title}

```{r ibge4}
g4 <- dados %>% 
  filter(abrangencia=='brasil') %>% 
  ggplot() +  #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=vbp/1000, fill="Valor Bruto Produção (Milhões R$)"), lwd=1)+
  scale_fill_manual(values=mycolor4)+
labs(y= "VBP (Milhões R$)", x= "Anos", title='Evolução do Valor Bruto da Produção com Manga no Brasil: 2013-2022',
       caption = "IBGE (2023)") +
  scale_y_continuous(limits=c(0, 2100), n.breaks = 8, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

VALE DO S. FRANCISCO {data-navmenu="DADOS GERAIS"}
======================================================================

Row {data-height=125}
-----------------------------------------------------------------------

### Área Plantada com Manga no Vale S. Francisco em 2022 
``` {r}
num <- 36.3 
valueBox(
  value = paste0(num, " Mil Hectares"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Produtividade média da Manga no Vale S. Francisco em 2022 
``` {r}
num <- 27
valueBox(
  value = paste0( num, " Toneladas/Hectare"),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Volume com Manga produzida no Vale S. Francisco em 2022 
``` {r}
num <- 976.1
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Mil Toneladas" ),
#  color = "lightblue3",
  icon= "fa-pen")
```

### Valor Produção com Manga produzida no Brasil em 2022 
``` {r}
num <- 1.23
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Bilhões de Reais" ),
#  color = "lightblue3",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Area Plantada com Manga - V. S. Francisco {.no-title}

```{r ibge1b}
g1 <- dados %>% 
  filter(abrangencia=='vale') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=area, fill="Área Manga (Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor1)+
  labs(y= "Hectares", x= "Anos", title='Evolução da Area com Manga no Vale do São Francisco: 2013-2022',
       caption = "Fonte: IBGE (2023)") +
  scale_y_continuous(limits=c(0, 40000), n.breaks = 8, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12))

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

### Volume Produzido de Manga -  V. S. Francisco {.no-title}

```{r ibge2b}
g2 <- dados %>% 
  filter(abrangencia=='vale') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=quantidade/1000, fill="Volume (Mil Toneladas)"), lwd=1)+
  scale_fill_manual(values=mycolor2)+
  labs(y= "Mil Toneladas", x= "Anos", title='Evolução do Volume com Manga no Vale do São Francisco: 2013-2022',
       caption = "Fonte: IBGE (2023)") +
  scale_y_continuous(limits=c(0, 1000), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Produtividade da Manga -  V. S. Francisco {.no-title}

```{r ibge3b}
g3 <- dados %>% 
  filter(abrangencia=='vale') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=produtividade, fill="Produtividade (Toneladas/Hectares)"), lwd=1)+
  scale_fill_manual(values=mycolor3)+
  labs(y= "Produtividade (Ton/Ha)", x= "Anos", title='Evolução da Produtividade com Manga no Vale do São Francisco: 2013-2022',
       caption = "IBGE (2023)") +
  scale_y_continuous(limits=c(0, 32), n.breaks = 6, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

### Valor Bruto da Produção com Manga -  V. S. Francisco {.no-title}

```{r ibge4b}
g4 <- dados %>% 
  filter(abrangencia=='vale') %>% 
  ggplot() + #estetica vai valer para todos os geom's
  geom_col(aes(x=ano, y=vbp/1000, fill="Valor Bruto Produção (Milhões R$)"), lwd=1)+
  scale_fill_manual(values=mycolor4)+
  labs(y= "VBP (Milhões R$)", x= "Anos", title='Evolução do Valor Bruto da Produção com Manga no Vale do São Francisco: 2013-2022',
       caption = "IBGE (2023)") +
  scale_y_continuous(limits=c(0, 1300), n.breaks = 5, expand = expansion(add=c(0,0.5)))+
  scale_x_continuous(breaks = seq(2013, 2022, by = 1))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=12, margin = margin(b=5)),
        axis.text.y=element_text(hjust=1, size=12, margin = margin(l=20)),
        axis.title.x = element_text(size=12, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=12, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=14),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.3,
                      title=''))
```

VOLUME CEASAS {data-navmenu="MERCADO INTERNO"}
======================================================================

```{r database4}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Inicio do Script
#Pacotes a serem utilizados
library(flexdashboard)
library(foreign)
library(mFilter)
library(forecast)
library(dplyr)
library(tsutils)
library(xts)
library(ggthemes)
library(FinTS)
library(scales)
library(ggplot2)
library(reshape)
library(reshape2)
library(imputeTS)
library(seasonal)
library(uroot)
library(tseries)
library(quantmod)
library(kableExtra)# complex tables
library(lmtest)
library(plotly)
#library(rmarkdown)
library(bslib)
library(readxl)

checkX13()

mycolors <- c("lightblue3", "gray44", "gold")
mycolors2 <- c("lightblue3", "orange")
mycolors3 <- c("blue", "orange")

#Entrando dados no R
dados1 <- read_excel('ceagesp_total.xlsx', col_names = TRUE)
dados1m <- melt(dados1, id.var='Anos')

#Entrando dados no R
dados2 <- read_excel('ceagesp_variedades.xlsx', col_names = TRUE)
dados2m <- melt(dados2, id.var='Anos')

#Entrando dados no R
manga_mespeba <- read_excel('ceagesp_tempo.xlsx', col_names = TRUE)

data <- as.Date("2022-07-01") #ajustar semanalmente
manga_mespeba$date <- seq(as.Date('2012-01-01'),to=data,by='1 month') 

#Tendencia PEBA
manga_mespeba2 <- ts(manga_mespeba$toneladas, start = c(2012,1), freq=12)
trend_peba <- cmav(manga_mespeba2, outplot=F)

#Comparações com os anos e entre as médias/max/min

meses <- seq(as.Date("2021/1/1"), by = "month", length.out = 12)

peba_2019 <- window(manga_mespeba2, end=c(2019,12))
seaspeba_19<-seasplot(peba_2019, trend=F, outplot = F)
mediaspeba_19 <- colMeans(seaspeba_19$season)

peba_2020 <- window(manga_mespeba2, end=c(2020,12))

peba_2021 <- window(manga_mespeba2, end=c(2021,12))
#seas21<-seasplot(preco_palmer_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

peba_22 <- as.matrix(tail(manga_mespeba2,7)) #ajustar mensalmente
peba_2022 <- matrix(NA, nrow=12, ncol=1)

mes<-7

for(i in 1:mes){
  peba_2022[i,1] = peba_22[i,1]
}

#Como só se tem até o mes 12
mediaspeba_19 <- mediaspeba_19[1:12]

matrixpeba = matrix(NA, nrow=12, ncol=2)

for(i in 1:12){
  matrixpeba[i,1] = min(seaspeba_19$season[,i])
  matrixpeba[i,2] = max(seaspeba_19$season[,i])
}

#time <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", #"Dezembro")
#time <-seq(1:12)
table_peba <- data.frame(meses, matrixpeba[,1], round(mediaspeba_19,1), matrixpeba[,2],
                         round(tail(peba_2020,12),1),
                    round(tail(peba_2021,12),1), peba_2022[,1])
colnames(table_peba) = c('Meses', 'Mínimo', 'Média', 'Máximo', '2020', '2021',
                    '2022')

tablepeba_a <- table_peba[,-c(5:7)]
tablepeba_b <- table_peba[,-c(2,3,4)]

tablepeba_a2 <- melt(tablepeba_a, id.var='Meses')
tablepeba_b2 <- melt(tablepeba_b, id.var='Meses')

```

Row {data-height=125}
-----------------------------------------------------------------------

### Volume Comercializado (CEAGESP) de Mangas em 2021 
``` {r v1}
num <- 98
valueBox(
  value = paste0(num, " Mil Toneladas"),
#  color = "tomato",
  icon= "fa-arrow-down")
```

### Volume Comercializado (CEAGESP) de Manga Palmer de 2021 
``` {r v2}
num <- 47.8
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Mil Toneladas"),
  icon= "fa-pen")
```

### Volume Comercializado (CEAGESP) de Manga Tommy de 2021 
``` {r v3}
num <- 40.3
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Mil Toneladas"),
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Volume total comercializado de manga: 2017 a 2022 {.no-title}
```{r mi1}
g1 <- ggplot()+
  geom_col(data=dados1m, aes(x=Anos, y=value, fill=variable), lwd=1, position = "dodge")+ scale_fill_manual(values=mycolors2)+
   scale_x_continuous(breaks = seq(2012, 2022, by = 1))+
  labs(y= "Toneladas", x= "Brasil e PE+BA", title='Volume total comercializado de manga (CEAGESP): 2012 a 2022',
  caption = "Fonte: CEAGESP reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=10, margin = margin(l=10)),
        axis.title.y = element_text(size=10, face = "bold"),
        axis.title.x = element_text(size=10, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=11),
        plot.caption = element_text(hjust = 0, size=10),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.38, 
                      y=-0.19,
                      title=''))
```

### Tendência do Volume comercializado de manga {.no-title}

```{r mi3}
#Gráfico com Ggplot2 - Tendencia

g3 <- ggplot(data=manga_mespeba, aes(x=date)) +  #estetica vai valer para todos os geom's
  geom_line(aes(y=toneladas, colour="TONELADAS"), lwd=0.5)+
  geom_line(aes(y=trend_peba, colour="TENDÊNCIA"), lwd=1)+
  scale_colour_manual("",
                      breaks = c("TONELADAS", "TENDÊNCIA"),
                      values = c("black", "tomato"))  +
  labs(y= "Quantidade (T)", x= "Meses do Ano", title='Tendência do Volume comercializado de manga (CEAGESP)',
       caption = "Fonte: CONAB reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
  scale_y_continuous(limits=c(0,17000), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  scale_x_date(date_breaks = "1 year",
               labels = date_format("%Y"))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=20)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=0)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=20)),
        plot.title = element_text(hjust = 0.5, size=11),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.18,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Estatísticas sobre a Evolução da Oferta de manga {.no-title}

```{r mi5, results='', fig.cap='', fig.width=7, fig.height=5, fig.align='center'}
#Evolução da Oferta Mensal de Manga PEBA nos CEASAS do Brasil

g5 <- ggplot()+
  geom_col(data=tablepeba_b2, aes(x=Meses, y=value, fill=variable), lwd=1,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
  geom_line(data=tablepeba_a2, aes(x=Meses, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
  scale_y_continuous(limits = c(0, 15000), n.breaks = 10)+
  scale_x_date(date_breaks = "1 month",
               labels = date_format("%B"))+
  labs(y= "Toneladas", x= "Meses do Ano", title='Estatísticas sobre a Evolução da Oferta de manga (CEAGESP)',
       caption = "")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=20)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=20)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=11),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g5) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.20, 
                      y=-0.16,
                      title=''))
```

### Volume total comercializado de manga variedades: 2017 a 2022 {.no-title}

```{r mi2}
g1 <- ggplot()+
  geom_col(data=dados2m, aes(x=Anos, y=value, fill=variable), lwd=1, position = "dodge")+ scale_fill_manual(values=mycolors3)+
   scale_x_continuous(breaks = seq(2012, 2022, by = 1))+
  labs(y= "Toneladas", x= "Variedades Palmer e Tommy Atkins", title='Volume total por variedade de manga (CEAGESP): 2012 a 2022',
  caption = "Fonte: CEAGESP reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=10, margin = margin(l=10)),
        axis.title.y = element_text(size=10, face = "bold"),
        axis.title.x = element_text(size=10, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=11),
        plot.caption = element_text(hjust = 0, size=10),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=9)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.17,
                      title=''))
```

CONSUMO MANGA {data-navmenu="MERCADO INTERNO"}
======================================================================

Row {data-height=125}
-----------------------------------------------------------------------

### per capita com manga em 2018 no Brasil  
``` {r cons1}
num <- 1.188
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Kg de Consumo"),
#  color = "green",
  icon= "fa-arrow-up")
```

### na região Sul, a maior consumidora em 2018  
``` {r cons2}
num <- 1.440
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " Kg de Consumo"),
#  color = "green",
  icon= "fa-arrow-up")
```

### de consumo de manga no Centro-Oeste em 2018 
``` {r cons3}

num <- 73.35
valueBox(
  value = paste0(format(num, decimal.mark =  ","), " % de Crescimento"),
#  color = "green",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Evolução do consumo de manga {.no-title}

```{r consumo_manga1}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Inicio do Script
#Pacotes a serem utilizados 
library(ggplot2)
library(scales)
library(plotly)
library(dplyr)
library(readxl)
library(reshape2)
library(kableExtra)# complex tables
library(lmtest)
library(DT)
library(magrittr)

mycolors2 <- c("darkgreen", "lightblue3", "orange")

#Entrando dados no R
dados1 <- read_excel('consumo_brasil.xlsx', col_names = TRUE)
dados1m <- melt(dados1, id.var='Região')

g1 <- ggplot()+
  geom_col(data=dados1m, aes(x=Região, y=value, fill=variable), lwd=1, position = "dodge")+ scale_fill_manual(values=mycolors2)+
  labs(y= "Consumo (kg) per capita anual", x= "Brasil e Regiões", title='Evolução da  aquisição domiciliar per capita anual de manga no Brasil e regiões',
  caption = "Fonte: POF/IBGE reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=10, margin = margin(l=10)),
        axis.title.y = element_text(size=10, face = "bold"),
        axis.title.x = element_text(size=10, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=10),
        plot.caption = element_text(hjust = 0, size=10),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.3, 
                      y=-0.2,
                      title=''))
```

### Evolução da variação do consumo de manga {.no-title}

```{r consumo_manga2}
consumo_var <- dados1[,-2]
variacao <- ((consumo_var[,3]-consumo_var[,2])/consumo_var[,2])*100
consumo_vara<-cbind(consumo_var, round(variacao,2))
consumo_var <- consumo_vara[,-c(2:3)]
colnames(consumo_var) = c('regiao', 'variacao')

mycolor1 <- "orange"

g2<- ggplot(data=consumo_var) +  #estetica vai valer para todos os geom's
  geom_col(aes(x = regiao, y=round(variacao,2), fill="Variação no Consumo de Manga (%) per capita anual"), lwd=1)+
  scale_fill_manual(values=mycolor1)+labs(y= "Variação no Consumo de Manga (%)", x= "Estados", title='Variação na aquisição domiciliar per capita anual de manga no Brasil e regiões entre 2008 e 2018',
       caption = "")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=10, margin = margin(l=10)),
        axis.title.y = element_text(size=10, face = "bold"),
        axis.title.x = element_text(size=10, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.3, 
                      y=-0.4,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Evolução da variação do consumo de manga {.no-title}

```{r consumo_manga3}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Inicio do Script
#Pacotes a serem utilizados 
library(ggplot2)
library(scales)
library(plotly)
library(dplyr)
library(readxl)

mycolor1 <- "gold"

#mycolors2 <- c("orange", "lightblue3", "gray44", "gold", "red", "darkgreen")

#Entrando dados no R
dados2 <- read_excel('consumo_estados.xlsx', col_names = TRUE)

g3 <- ggplot(data=dados2) +  #estetica vai valer para todos os geom's
  geom_col(aes(x = reorder(regiao, -consumo), y= consumo, fill="Consumo (kg) per capita anual"), lwd=1)+scale_fill_manual(values=mycolor1)+labs(y= "Consumo (kg) per capita anual", x= "Estados", title='Aquisição domiciliar per capita anual de manga por estados - 2018',
       caption = "")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8.5, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=10, margin = margin(l=10)),
        axis.title.y = element_text(size=10, face = "bold"),
        axis.title.x = element_text(size=10, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=10),
        plot.caption = element_text(hjust = 0, size=10),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.3, 
                      y=-0.50,
                      title=''))
```

### Evolução da variação do consumo de manga {.no-title}

```{r consumo_manga4}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Inicio do Script
#Pacotes a serem utilizados 
library(ggplot2)
library(scales)
library(plotly)
library(dplyr)
library(readxl)

mycolors2 <- c("orange", "lightblue3", "darkblue", "gold", "red", "darkgreen")

#Entrando dados no R
#dados3 <- read_excel('consrenda_brasil.xlsx', col_names = TRUE)
dados3 <- read.csv2('consrenda_brasil.csv', header=T, sep=";", dec=".", stringsAsFactors = TRUE)
dados3$classes <- factor(dados3$classes, levels = c("Até 1.908 Reais", "Mais de 1.908 a 2.862 Reais", "Mais de 2.862 a 5.724 Reais",
                                                    "Mais de 5.724 a 9.540 Reais", "Mais de 9.540 a 14.310 Reais", "Mais de 14.310 Reais"))
#dados3$classes <- as.factor(dados3$classes)  
dados3m <- melt(dados3, id.var='classes')

g4 <- ggplot()+
  geom_col(data=dados3m, aes(x=variable, y=value, fill=classes), lwd=1, position = "dodge")+ scale_fill_manual(values=mycolors2)+
  labs(y= "Consumo (kg) per capita anual", x= "Brasil e Regiões", title='Aquisição domiciliar per capita anual de manga por faixas de renda - 2018',
  caption = "Fonte: POF/IBGE reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=10, margin = margin(l=10)),
        axis.title.y = element_text(size=10, face = "bold"),
        axis.title.x = element_text(size=10, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=10),
        plot.caption = element_text(hjust = 0, size=10),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.0, 
                      y=-0.45,
                      title=''))
```

MERCADO TRABALHO {data-navmenu="MERCADO INTERNO"}
======================================================================

```{r database6}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_caged')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_caged')

atual <-  as.Date("2024-03-01")
#today <- as.Date("2022-02-11")


#Inicio do Script
#Pacotes a serem utilizados 
library(ggplot2)
library(scales)
library(plotly)

#Entrando dados no R
dados1 <- read.csv2('marco_2024.csv', header=T, sep=";", dec = ".")
colnames(dados1)[1] <- 'date'
dados1$date <- seq(as.Date('2021-01-01'),to=atual,by='1 month')
dados1a <- dados1 
dados1a$ano <- strftime(dados1a$date, format="%Y") 
dados1a$mes <- strftime(dados1a$date, format="%b") 

saldo_23 <- dados1a %>% filter(ano=='2023')

saldo_23 <- saldo_23 %>%
  select(c(ano, mes, Saldo_Manga))

saldo_24 <- dados1a %>% filter(ano=='2024')

saldo_24 <- saldo_24 %>%
  select(c(ano, mes, Saldo_Manga))

saldom <- rbind(saldo_23, saldo_24)
saldom$mes <- factor(saldom$mes,levels = c("Jan", "Fev", "Mar", "Abr", "Mai", 
                                           "Jun", "Jul", "Ago", "Set", "Out",
                                           "Nov", "Dez"))

#Entrando com o restante dos dados

load("marco_24_caged.RData")

#dados_02_vsf$sexo <- lapply(dados_02_vsf$sexo, factor)

dados_03_vsf$sexo[dados_03_vsf$sexo == 1] <- 0
dados_03_vsf$sexo[dados_03_vsf$sexo == 3] <- 1

dados_03_vsf <- mutate(dados_03_vsf,
                sexo = factor(sexo, levels = 0:1, labels = c("Masculino", "Feminino")))

# Mantendo apenas 

#Separando as admissoes e as demissoes
dados_03_vsf_positivos <-dados_03_vsf%>% filter(saldo_movim=="1")
dados_03_vsf_negativos <-dados_03_vsf%>% filter(saldo_movim=="-1")

#Mantendo apenas o agronegocio
secao_positivos <-dados_03_vsf_positivos%>% filter(secao=="A")
secao_negativos <-dados_03_vsf_negativos%>% filter(secao=="A")

#Mantendo apenas a manga
subclasse_positivos <-dados_03_vsf_positivos%>% filter(subclasse=="133410")
subclasse_negativos <-dados_03_vsf_negativos%>% filter(subclasse=="133410")

subclasse_positivos <- mutate(subclasse_positivos,
                grau_instrucao = factor(grau_instrucao, levels = 1:13, 
                                        labels = c("Analfabeto",
                                                   "Até 5ª Incompleto",
                                                   "5ª Completo Fundamental",
                                                   "6ª a 9ª Fundamental",
                                                   "Fundamental Completo",
                                                   "Médio Incompleto",
                                                   "Médio Completo",
                                                   "Superior Incompleto",
                                                   "Superior Completo",
                                                   "Mestrado",
                                                   "Doutorado",
                                                   "Pós-Graduação completa",
                                                   "Não Identificado")))

# Ajustando a variavel salario
subclasse_positivos$salario <- as.numeric(sub(',', '.', subclasse_positivos$salario, fixed = TRUE))

subclasse_positivos$salario <- as.integer(subclasse_positivos$salario)
```

Row {data-height=125}
-----------------------------------------------------------------------

### pela mangicultura em `r strftime(atual, format = "%B")` de 2024 
``` {r emp1}
num <- 955
valueBox(
  value = paste0(num, " Contratados"),
#  color = "green",
  icon= "fa-arrow-up")
```

### pela mangicultura em `r strftime(atual, format = "%B")` de 2024 
``` {r emp2}
num <- 707
valueBox(
  value = paste0(num, " Demitidos"),
#  color = "tomato",
  icon= "fa-arrow-down")
```

### Saldo Gerado pela mangicultura em `r strftime(atual, format = "%B")` de 2024 
``` {r emp3}
num <- 248
valueBox(
  value = paste0(num, " Empregos"),
#  color = "tomato",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Evolução do saldo de Empregos gerados na manga {.no-title}

```{r emp4}
#Gráfico com Ggplot2

mycolor1 <- "gold"
mycolors2 <- c("orange", "lightblue3")

g1 <- ggplot() +  #estetica vai valer para todos os geom's
  geom_col(data=saldom, aes(x=mes, y=Saldo_Manga, fill=ano), size=2, width = 0.9, position = "dodge")+
    scale_fill_manual(values=mycolors2)+
    labs(y= "Saldo de Emprego (unidade)", x= "Meses do Ano", title='Saldo mensal de Empregos na Mangicultura: 2023 e 2024',
       caption = "")+
    scale_y_continuous(limits=c(-1500, 1300), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.45, 
                      y=-0.25,
                      title=''))
```

### Empregos gerados na manga por gênero {.no-title}

``` {r emp5}
### Histograma

g2 <- ggplot(data = subclasse_positivos, aes(x = sexo, y = ..count..)) +
  geom_bar(fill='steelblue')+
    labs(y= "Contratados Manga - VSF", x= "Gênero", title='Distribuição dos empregos gerados por gênero',
       caption = "")+
  theme_minimal()+ #Definindo tema
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda

ggplotly(g2)
```

Row
-----------------------------------------------------------------------

### Empregos gerados na manga por idade {.no-title}

``` {r emp6}
### Histograma

g3 <- ggplot(data=subclasse_positivos, aes(x=idade))+
  geom_histogram(binwidth=3, fill="#69b3a2", color="#e9ecef", alpha=0.9)+
    scale_x_continuous(limits=c(18, 65), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
    labs(y= "Contratados Manga - VSF", x= "Idades", title='Distribuição dos empregos gerados por idade',
       caption = "")+
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda
  
ggplotly(g3)
``` 


### Empregos gerados na manga por grau de instrução {.no-title}

``` {r emp7}
### Histograma

g4 <- ggplot(data = subclasse_positivos, aes(x = grau_instrucao, y = ..count..)) +
  geom_bar(fill='#1e4971')+
    scale_y_continuous(limits=c(0, 500), n.breaks = 10, expand = expansion(add=c(0,0.5)))+
labs(y= "Contratados Manga - VSF", x= "Grau de Instrução", title='Grau de Instrução dos empregos gerados',
       caption = "")+
  theme_minimal() +
  theme(axis.text.x=element_text(angle=30, hjust=1, size=10, margin = margin(b=20)),
        axis.text.y=element_text(hjust=1, size=10, margin = margin(l=20)),
        axis.title.x = element_text(size=10, face = "bold", margin = margin(b=20)),
        axis.title.y = element_text(size=10, face = "bold", margin = margin(l=20)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=12),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=12)) # Definindo posição da legenda
  
ggplotly(g4)
```

PALMER {data-navmenu="PREÇOS AO PRODUTOR"}
======================================================================

``` {r database1}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

data <- as.Date("2024-05-10") #ajustar semanalmente

#Entrando dados no R
dados <- read.csv2('dados_manga_palmer_semana.csv', header=T, sep=";", dec=".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados)[1]<-'produto'

#Entrando dados no R - Deflator
igpdi <- read.csv2('igpdi.csv', 
                   header=T, sep=";",
                   dec=".")

dados_comb<-cbind(dados, igpdi)

teste<-dados_comb[,4]-dados_comb[,7]

dadosp<-dados_comb[,-c(1,2,6,7)]

#Deflacionar a serie de manga
dadosp$preco_def <- dadosp[,3]*(tail(dadosp[,4],1)/dadosp[,4])
#dadosp<-dadosp[,-2]

#Criando uma variável com as datas semanais
dadosp$date <- seq(as.Date('2012-01-14'),to=data,by='1 week') 
dadosp$date[dadosp$date == "2016-01-02"] <- "2015-12-31" #ajustando algumas datas
dadosp$date[dadosp$date == "2015-01-03"] <- "2014-12-31"
dadosp$date[dadosp$date == "2014-01-04"] <- "2013-12-31"
dadosp$date[dadosp$date == "2013-01-05"] <- "2012-12-31"
dadosp$date[dadosp$date == "2022-01-01"] <- "2022-01-03"
dadosp$date[dadosp$date == "2022-12-31"] <- "2023-01-01"

#Analise de Serie Temporal
preco_palmer <- dadosp[,5]
preco_palmer <- ts(preco_palmer, start=c(2012,1), freq=52)
#preco_palmer <- window(preco_palmer, end=c(2021,52))

# Parte 2
#Decompor a série
decompa<-decompose(preco_palmer, type = 'multiplicative')

#Tendecia
trend_palmer <- cmav(preco_palmer, outplot=F)

#Sazonalidade
sazonalidade <- decompa$figure
semanas <- seq(1:52)
sazonal_graph <- tibble(cbind(semanas, sazonalidade))

#Parte 3
#Analise das comparações entre as médias

preco_palmer_2023 <- window(preco_palmer, end=c(2023,52))
seas23 <-seasplot(preco_palmer_2023, trend=F, outplot = F)
medias23 <- colMeans(seas23$season)

preco_palmer_2022 <- window(preco_palmer, end=c(2022,52))

#preco_palmer_2023 <- window(preco_palmer, end=c(2023,52))
#seas21<-seasplot(preco_palmer_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

preco_palmer_24 <- as.matrix(tail(dadosp$preco_def,sem_ano)) 
preco_palmer_2024 <- matrix(NA, nrow=52, ncol=1)

for(i in 1:sem_ano){
  preco_palmer_2024[i,1] = preco_palmer_24[i,1]
}
  

#Como só se tem até a semana 52
medias23 <- medias23[1:52]
#medias21 <- medias21[1:52]

matrix = matrix(NA, nrow=52, ncol=2)

for(i in 1:52){
  matrix[i,1] = min(seas23$season[,i])
  matrix[i,2] = max(seas23$season[,i])
}

time <- seq(1:52)
table <- data.frame(time, matrix[,1], round(medias23,2), matrix[,2], round(tail(preco_palmer_2022,52),2),
                    round(tail(preco_palmer_2023,52),2), preco_palmer_2024[,1])
colnames(table) = c('Semanas', 'Mínimo', 'Média', 'Máximo', 'Ano 2022', 'Ano 2023', 
                    'Ano 2024')

tablea <- table[,-c(5:7)]
tableb <- table[,-c(2,3,4)]

tablea2 <- melt(tablea, id.var='Semanas')
tableb2 <- melt(tableb, id.var='Semanas')
mycolors <- c("lightblue3", "gray44", "gold")

table_db <- data.frame(matrix[,1], round(medias23,2), matrix[,2], round(tail(preco_palmer_2022,52),2),
                    round(tail(preco_palmer_2023,52),2), preco_palmer_2024[,1])
colnames(table_db) = c('Mínimo', 'Média', 'Máximo', '2022', '2023', '2024')

#Parte 4

preco_palmer_23 <- dadosp %>% filter(ano=='2023')
preco_palmer_2023 <- as.matrix(preco_palmer_23$preco_def)
variacao_23 <- (preco_palmer_2023/lag(preco_palmer_2023, 1) - 1)*100

variacao_24 <- (preco_palmer_2024/lag(preco_palmer_2024, 1) - 1)*100

semanas <- seq(1:52)
variacao <- data.frame(semanas, variacao_23[,1], variacao_24[,1])
colnames(variacao) = c('Semanas', 'Ano 2023', 'Ano 2024')

#Ajuste para a Tabela da Variação
variacaot <- variacao[,-1]
colnames(variacaot) = c('Variação em 2023', 'Variação em 2024')

variacao <- melt(variacao, id.var='Semanas')

mycolors2 <- c("orange", "lightblue3")

# Customizar tema interativamente em tempo real (ver mensagens no console)
#bslib::bs_themer()

```

Row {data-height=125}
-----------------------------------------------------------------------

### Preço de Palmer na Semana `r strftime(data, format = "%V")` de 2024 
``` {r}
num <- tail(preco_palmer,1)
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
#  color = "tomato",
  icon= "fa-arrow-up")
```

### Preço de Palmer na Semana `r strftime(data, format = "%V")` de 2023
``` {r}
num <- 2.48
valueBox(
  value = paste0( "R$", format(round(num,2), decimal.mark =  ",")),
#  color = "#edc40c",
  icon= "fa-pen")
```

### Preço de Palmer na Semana `r strftime(data, format = "%V")` de 2022
``` {r}
num <- 2.30
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
#  color = "#edc40c",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

### Mínimo, Máximo, Media e Preços de Palmer {.no-title}

```{r palmer3, results='', fig.cap='', fig.width=6, fig.height=4, fig.align='center'}

g1 <- ggplot()+
  geom_col(data=tableb2, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.7,
           position = "dodge")+
  scale_fill_manual(values=mycolors)+
    geom_line(data=tablea2, aes(x=Semanas, y=value, colour=variable), linetype = "solid",
            size = 1)+
  scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
  scale_y_continuous(limits = c(0, 8), n.breaks = 8, labels = number_format(accuracy = 0.01,
                                                       decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 1))+
  labs(y= "Preço Palmer (R$)", x= "Semanas de cada Ano", title='Mínimo, Máximo, Média e preços de 2022 a 2024 de Manga Palmer ao produtor',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
  theme_minimal()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=8),
        plot.title = element_text(hjust = 0.5, size=12, face=""),
        legend.position = "right", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g1) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.20, 
                      y=-0.3,
                      title=''))
```

### Variação Semanal do Preços {.no-title}

```{r palmer5, results='', fig.cap='', fig.width=5, fig.height=4}

g2 <- ggplot()+
  geom_col(data=variacao, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.9, position = "dodge")+
  scale_fill_manual(values=mycolors2)+
  scale_y_continuous(labels = number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "Variação Percentual", x= "Semanas do Ano", title='Variação Semanal de preços de Manga Palmer ao produtor',
       caption = "Fonte: Observatório de Mercado de Manga da Embrapa")+
  theme_minimal()+
   theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(hjust = 0, size=8),
        plot.title = element_text(hjust = 0.5, size=12, face=""),
        legend.position = "right", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g2) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.2,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Preço e Tendência de Palmer {.no-title}

```{r palmer1, results='', fig.cap='', fig.width=6, fig.height=4}
#Gráfico com Ggplot2

g3 <- ggplot(data=dadosp, aes(x=date)) +  #estetica vai valer para todos os geom's
  geom_line(aes(y=preco_def, colour="PREÇO"), lwd=0.5)+
  geom_line(aes(y=trend_palmer, colour="TENDÊNCIA"), lwd=1)+
  scale_colour_manual("", 
                      breaks = c("PREÇO", "TENDÊNCIA"),
                      values = c("black", "tomato")) +
  labs(y= "Preço Palmer (R$)", x= "Semanas de cada Ano", title='Evolução dos preços ao produtor e Tendência Manga Palmer',
       caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Manga da Embrapa") +
  scale_y_continuous(limits=c(0,8), n.breaks = 9, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_date(date_breaks = "6 months",
               labels = date_format("%b-%Y"))+
  theme_classic()+ #Definindo tema
  theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=1, size=8, margin = margin(l=10)),
        axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
        axis.title.y = element_text(size=8, face = "bold", margin = margin(l=10)),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = c(2,1),
        legend.justification = c(1.2, 1.2),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g3) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.30,
                      title=''))
```

### Sazonalidade de Palmer {.no-title}

```{r palmer2, results='', fig.cap='', fig.width=5, fig.height=4, fig.align='center'}
#Decompor a Série

g4 <- ggplot(data=sazonal_graph)+
  geom_line(aes(x=semanas, y=sazonalidade), color="cornflowerblue", size=1.2)+
  scale_y_continuous(limits=c(0,1.8), n.breaks = 5, expand = expansion(add=c(0,0.5)), 
                     labels=number_format(accuracy = 0.01, decimal.mark = ","))+
  scale_x_continuous(breaks = seq(1, 52, by = 2))+
  labs(y= "", x= "Semanas de cada Ano", title='Sazonalidade do preço de Manga Palmer',
       caption = "Fonte: Observatório de Mercado de Manga da Embrapa")+
  theme_classic()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
        axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
        axis.title.y = element_text(size=8, face = "bold"),
        axis.title.x = element_text(size=8, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5, size=12),
        plot.caption = element_text(hjust = 0, size=8),
        legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g4) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.25, 
                      y=-0.2,
                      title=''))
```

TOMMY {data-navmenu="PREÇOS AO PRODUTOR"}
======================================================================

``` {r database2}
#Direcionado o R para o Diretorio a ser trabalhado
#setwd('c:/Users/Joao Ricardo Lima/Dropbox/tempecon/dados_manga')
setwd('/Users/jricardofl/Dropbox/tempecon/dados_manga')

#Entrando dados no R
dados <- read.csv2('dados_manga_tommy_semana.csv', header=T, sep=";", dec=".")
#dados <- dados[,-c(9:10)] #retirar as ultimas colunas
colnames(dados)[1]<-'produto'

#Entrando dados no R - Deflator
igpdi <- read.csv2('igpdi.csv', 
                   header=T, sep=";",
                   dec=".")

dados_comb<-cbind(dados, igpdi)

teste<-dados_comb[,4]-dados_comb[,7]

dadosp<-dados_comb[,-c(1,2,6,7)]

#Deflacionar a serie de manga
dadosp$preco_def <- dadosp[,3]*(tail(dadosp[,4],1)/dadosp[,4])
#dadosp<-dadosp[,-2]

#Criando uma variável com as datas semanais
dadosp$date <- seq(as.Date('2012-01-14'),to=data,by='1 week') 
dadosp$date[dadosp$date == "2016-01-02"] <- "2015-12-31" #ajustando algumas datas
dadosp$date[dadosp$date == "2015-01-03"] <- "2014-12-31"
dadosp$date[dadosp$date == "2014-01-04"] <- "2013-12-31"
dadosp$date[dadosp$date == "2013-01-05"] <- "2012-12-31"
dadosp$date[dadosp$date == "2022-12-31"] <- "2023-01-01"

#Analise de Serie Temporal
preco_tommy <- dadosp[,5]
preco_tommy <- ts(preco_tommy, start=c(2012,1), freq=52)
#preco_tommy <- window(preco_tommy, end=c(2021,52))

# Parte 2
#Decompor a série
decompa<-decompose(preco_tommy, type = 'multiplicative')

#Tendencia
trend_tommy <-cmav(preco_tommy, outplot=F)

#Sazonalidade
sazonalidade <- decompa$figure
semanas <- seq(1:52)
sazonal_graph <- tibble(cbind(semanas, sazonalidade))

#Parte 3
#Analise das comparações entre as médias
preco_tommy_2023 <- window(preco_tommy, end=c(2023,52))
seas23 <- seasplot(preco_tommy_2023, trend=F, outplot = F)
medias23 <- colMeans(seas23$season)

preco_tommy_2022 <- window(preco_tommy, end=c(2022,52))

#preco_tommy_2023 <- window(preco_tommy, end=c(2023,52))
#seas21<-seasplot(preco_tommy_2021, trend=F, outplot = F)
#medias21 <- colMeans(seas21$season)

preco_tommy_24 <- as.matrix(tail(dadosp$preco_def,sem_ano)) 
preco_tommy_2024 <- matrix(NA, nrow=52, ncol=1)

for(i in 1:sem_ano){
  preco_tommy_2024[i,1] = preco_tommy_24[i,1]
}

#Como só se tem até a semana 52
#medias20 <- medias20[1:52]
medias23 <- medias23[1:52]

matrix = matrix(NA, nrow=52, ncol=2)

for(i in 1:52){
  matrix[i,1] = min(seas23$season[,i])
  matrix[i,2] = max(seas23$season[,i])
}

time <- seq(1:52)
table <- data.frame(time, matrix[,1], round(medias23,2), matrix[,2], round(tail(preco_tommy_2022,52),2),
                    round(tail(preco_tommy_2023,52),2), preco_tommy_2024[,1])
colnames(table) = c('Semanas', 'Mínimo', 'Média', 'Máximo', 'Ano 2022', 'Ano 2023', 
                    'Ano 2024')

tablea <- table[,-c(5:7)]
tableb <- table[,-c(2,3,4)]

tablea2 <- melt(tablea, id.var='Semanas')
tableb2 <- melt(tableb, id.var='Semanas')
mycolors <- c("lightblue3", "gray44", "gold")

table_db <- data.frame(time, matrix[,1], round(medias23,2), matrix[,2], round(tail(preco_tommy_2022,52),2),
                    round(tail(preco_tommy_2023,52),2), preco_tommy_2024[,1])
colnames(table_db) = c('Semanas', 'Mínimo', 'Média', 'Máximo', 'Ano 2022', 'Ano 2023', 
                    'Ano 2024')

#Parte 4

preco_tommy_23 <- dadosp %>% filter(ano=='2023')
preco_tommy_2023 <- as.matrix(preco_tommy_23$preco_def)
variacao_23 <- (preco_tommy_2023/lag(preco_tommy_2023, 1) - 1)*100

variacao_24 <- (preco_tommy_2024/lag(preco_tommy_2024, 1) - 1)*100

semanas <- seq(1:52)
variacao <- data.frame(semanas, variacao_23[,1], variacao_24[,1])
colnames(variacao) = c('Semanas', 'Ano 2023', 'Ano 2024')

variacao <- melt(variacao, id.var='Semanas')

mycolors2 <- c("orange", "lightblue3")
```

Row {data-height=125}
-----------------------------------------------------------------------

### Preço de Tommy na Semana `r strftime(data, format = "%V")` de 2024
``` {r}
num <- tail(preco_tommy,1)
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
#  color = "tomato",
  icon= "fa-arrow-up")
```

### Preço de Tommy na Semana `r strftime(data, format = "%V")` de 2023
``` {r}
num <- 2.35
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
#  color = "#edc40c",
  icon= "fa-pen")
```

### Preço de Tommy na Semana `r strftime(data, format = "%V")` de 2022
``` {r}
num <- 2.16
valueBox(
  value = paste0( "R$", format(num, decimal.mark =  ",")),
#  color = "#edc40c",
  icon= "fa-pen")
```

Row
-----------------------------------------------------------------------

###  Mínimo, Máximo, Media e Preços de Tommy {.no-title}

```{r tommy3, results='', fig.cap='', fig.width=6, fig.height=4, fig.align='center'}

g5 <- ggplot()+
    geom_col(data=tableb2, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.7,
             position = "dodge")+
    scale_fill_manual(values=mycolors)+
    geom_line(data=tablea2, aes(x=Semanas, y=value, colour=variable), linetype = "solid",
              size = 1)+
    scale_colour_manual(values = c("red", "chocolate", "darkgreen")) +
    scale_y_continuous(limits = c(0, 8), n.breaks = 8, labels = number_format(accuracy = 0.01,
                                                                              decimal.mark = ","))+
    scale_x_continuous(breaks = seq(1, 52, by = 1))+
    labs(y= "Preço Tommy (R$)", x= "Semanas de cada Ano", title='Mínimo, Máximo, Média e preços de 2022 a 2024 de Manga Tommy ao produtor',
         caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Manga da Embrapa")+
    theme_minimal()+
    theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
          axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
          axis.title.y = element_text(size=8, face = "bold"),
          axis.title.x = element_text(size=8, face = "bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(hjust = 0, size=8),
          plot.title = element_text(hjust = 0.5, size=12, face=""),
          legend.position = "right", legend.title = element_blank(),
          legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g5) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.20, 
                      y=-0.3,
                      title=''))
```

### Variação Semanal do Preços {.no-title}

```{r tommy5, results='', fig.cap='', fig.width=5, fig.height=4}

g6 <- ggplot()+
    geom_col(data=variacao, aes(x=Semanas, y=value, fill=variable), size=2, width = 0.9, position = "dodge")+
    scale_fill_manual(values=mycolors2)+
    scale_y_continuous(labels = number_format(accuracy = 0.01, decimal.mark = ","))+
    scale_x_continuous(breaks = seq(1, 52, by = 2))+
    labs(y= "Variação Percentual", x= "Semanas do Ano", title='Variação Semanal de preços de Manga Tommy ao produtor',
         caption = "Fonte: Observatório de Mercado de Manga da Embrapa")+
    theme_minimal()+
    theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
          axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
          axis.title.y = element_text(size=8, face = "bold"),
          axis.title.x = element_text(size=8, face = "bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(hjust = 0, size=8),
          plot.title = element_text(hjust = 0.5, size=12, face=""),
          legend.position = "right", legend.title = element_blank(),
          legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g6) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.2,
                      title=''))
```

Row
-----------------------------------------------------------------------

### Preço e Tendência de Tommy {.no-title}

```{r tommy1, results='', fig.cap='', fig.width=6, fig.height=4}
#Gráfico com Ggplot2

g7 <- ggplot(data=dadosp, aes(x=date)) +  #estetica vai valer para todos os geom's
    geom_line(aes(y=preco_def, colour="PREÇO"), lwd=0.5)+
    geom_line(aes(y=trend_tommy, colour="TENDÊNCIA"), lwd=1)+
    scale_colour_manual("", 
                        breaks = c("PREÇO", "TENDÊNCIA"),
                        values = c("black", "tomato")) +
    labs(y= "Preço Tommy (R$)", x= "Semanas de cada Ano", title='Evolução dos preços ao produtor e Tendência Manga Tommy',
         caption = "Fonte: CEPEA reprocessado pelo Observatório de Mercado de Manga da Embrapa") +
    scale_y_continuous(limits=c(0,8), n.breaks = 9, expand = expansion(add=c(0,0.5)), 
                       labels=number_format(accuracy = 0.01, decimal.mark = ","))+
    scale_x_date(date_breaks = "6 months",
                 labels = date_format("%b-%Y"))+
    theme_classic()+ #Definindo tema
    theme(axis.text.x=element_text(angle=35, hjust=0.5, size=8, margin = margin(b=10)),
          axis.text.y=element_text(hjust=1, size=8, margin = margin(l=10)),
          axis.title.x = element_text(size=8, face = "bold", margin = margin(b=10)),
          axis.title.y = element_text(size=8, face = "bold", margin = margin(l=10)),
          plot.title = element_text(hjust = 0.5, size=12, face=""),
          plot.caption = element_text(hjust = 0, size=8),
          legend.position = c(2,1),
          legend.justification = c(1.2, 1.2),
          legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g7) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.35, 
                      y=-0.30,
                      title=''))
```

### Sazonalidade de Tommy {.no-title}
  
```{r tommy2, results='', fig.cap='', fig.width=5, fig.height=4, fig.align='center'}
#Decompor a Série

g8 <- ggplot(data=sazonal_graph)+
    geom_line(aes(x=semanas, y=sazonalidade), color="cornflowerblue", size=1.2)+
    scale_y_continuous(limits=c(0,1.8), n.breaks = 5, expand = expansion(add=c(0,0.5)), 
                       labels=number_format(accuracy = 0.01, decimal.mark = ","))+
    scale_x_continuous(breaks = seq(1, 52, by = 2))+
    labs(y= "", x= "Semanas de cada Ano", title='Sazonalidade do preço de Manga Tommy',
         caption = "Fonte: Observatório de Mercado de Manga da Embrapa")+
    theme_classic()+
    theme(axis.text.x=element_text(angle=0, hjust=0.5, size=8, margin = margin(b=10)),
          axis.text.y=element_text(hjust=0.5, size=8, margin = margin(l=10)),
          axis.title.y = element_text(size=8, face = "bold"),
          axis.title.x = element_text(size=8, face = "bold"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(hjust = 0.5, size=8),
          plot.title = element_text(hjust = 0.5, size=12, face=""),
          legend.position = "bottom", legend.title = element_blank(),
          legend.text=element_text(size=8)) # Definindo posição da legenda

ggplotly(g8) %>%
  layout(legend = list(
                      orientation = "h", 
                      x=0.25, 
                      y=-0.2,
                      title=''))
```
